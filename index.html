<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;font-family:Segoe UI,system-ui}
body{margin:0;background:#f5f6f8}
header{background:#fff;padding:15px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.container{max-width:1200px;margin:auto;padding:20px}
.flex{display:flex;justify-content:space-between;align-items:center}
nav button{margin-left:10px;border:none;background:#eee;padding:8px 14px;border-radius:6px;cursor:pointer}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px}
.card{background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.1)}
.card img{width:100%;height:250px;object-fit:cover}
.card-body{padding:15px}
.price{color:#ff6b35;font-weight:bold}
.btn{padding:10px;border:none;border-radius:6px;cursor:pointer;margin-top:8px}
.btn-orange{background:#ff6b35;color:#fff}
.btn-blue{background:#4a90e2;color:#fff}
.btn-red{background:#e74c3c;color:#fff}
.hidden{display:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
.modal-content{background:#fff;padding:20px;border-radius:10px;width:90%;max-width:500px}
input,textarea,select{width:100%;padding:10px;margin-bottom:10px}
.cart-item{display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:10px 0}

/* FIXED: admin unlock area no longer blocks header */
.secret-admin-area{
  position:fixed;
  top:0;
  right:0;
  width:120px;
  height:40px;
  z-index:200;
}
</style>
</head>

<body>

<div class="secret-admin-area" onclick="unlockAdmin()"></div>

<header>
<div class="container flex">
<b>ðŸ›’ My Store</b>
<nav>
<button onclick="openCart()">Cart (<span id="cartCount">0</span>)</button>
<button id="adminBtn" onclick="openAdmin()" style="display:none">Admin</button>
</nav>
</div>
</header>

<div class="container">

<section id="store">
<div class="grid" id="productGrid"></div>
</section>

<section id="admin" class="hidden">
<h2>Admin Panel</h2>
<input id="name" placeholder="Product name">
<input id="price" type="number" placeholder="Price">
<input id="stock" type="number" placeholder="Stock">
<input id="size" placeholder="Sizes (S,M,L)">
<input type="file" id="image">
<img id="preview" style="width:100%;max-height:200px;object-fit:contain">
<button class="btn btn-orange" onclick="saveProduct()">Save</button>

<h3>Orders</h3>
<div id="orders"></div>

<button class="btn btn-red" onclick="logout()">Logout</button>
</section>

</div>

<!-- LOGIN -->
<div class="modal" id="loginModal">
<div class="modal-content">
<h3>Admin Login</h3>
<input id="user" value="admin">
<input id="pass" type="password">
<button class="btn btn-blue" onclick="login()">Login</button>
</div>
</div>

<!-- CART -->
<div class="modal" id="cartModal">
<div class="modal-content">
<h3>Cart</h3>
<div id="cartItems"></div>
<h4 id="cartTotal"></h4>

<input id="cname" placeholder="Name">
<input id="cphone" placeholder="Phone">
<textarea id="caddr" placeholder="Address"></textarea>

<button class="btn btn-orange" onclick="sendOrder()">Send Order</button>
<button class="btn btn-red" onclick="closeCart()">Close</button>
</div>
</div>

<script>
const productGrid=document.getElementById("productGrid");
const cartCount=document.getElementById("cartCount");
const admin=document.getElementById("admin");
const store=document.getElementById("store");
const adminBtn=document.getElementById("adminBtn");

let products=JSON.parse(localStorage.getItem("products"))||[];
let cart=JSON.parse(localStorage.getItem("cart"))||[];
let orders=JSON.parse(localStorage.getItem("orders"))||[];
let isAdmin=localStorage.getItem("admin")==="true";
let adminUnlocked=localStorage.getItem("adminUnlocked")==="true";

const PAYWAY_LINK="https://link.payway.com.kh/08407860s";
const PAGE_NAME="Goatkids";
const SECRET_UNLOCK_PASSWORD="admin123";

if(!localStorage.getItem("adminPassword")){
  localStorage.setItem("adminPassword","admin123");
}

function unlockAdmin(){
  const p=prompt("Admin password");
  if(p===SECRET_UNLOCK_PASSWORD){
    adminUnlocked=true;
    localStorage.setItem("adminUnlocked","true");
    adminBtn.style.display="inline-block";
    alert("Admin unlocked");
  }
}

function openAdmin(){
  if(!adminUnlocked)return unlockAdmin();
  if(!isAdmin)return document.getElementById("loginModal").style.display="flex";
  store.classList.add("hidden");
  admin.classList.remove("hidden");
  renderOrders();
}

function login(){
  const pass=document.getElementById("pass").value;
  if(pass===localStorage.getItem("adminPassword")){
    isAdmin=true;
    localStorage.setItem("admin","true");
    document.getElementById("loginModal").style.display="none";
    openAdmin();
  }else alert("Wrong password");
}

function logout(){
  isAdmin=false;
  localStorage.removeItem("admin");
  admin.classList.add("hidden");
  store.classList.remove("hidden");
}

document.getElementById("image").onchange=e=>{
  const r=new FileReader();
  r.onload=()=>document.getElementById("preview").src=r.result;
  r.readAsDataURL(e.target.files[0]);
};

function saveProduct(){
  products.push({
    id:Date.now(),
    name:name.value,
    price:+price.value,
    stock:+stock.value,
    sizes:size.value?size.value.split(","):[],
    image:preview.src
  });
  localStorage.setItem("products",JSON.stringify(products));
  render();
}

function render(){
  productGrid.innerHTML="";
  products.forEach(p=>{
    productGrid.innerHTML+=`
    <div class="card">
      <img src="${p.image}">
      <div class="card-body">
        <b>${p.name}</b>
        <div class="price">$${p.price}</div>
        <select id="s${p.id}">
          ${p.sizes.length?p.sizes.map(s=>`<option>${s}</option>`).join(""):`<option>One Size</option>`}
        </select>
        <button class="btn btn-orange" onclick="addToCart(${p.id})">Add</button>
      </div>
    </div>`;
  });
  updateCartCount();
}

function addToCart(id){
  const p=products.find(x=>x.id===id);
  cart.push({id:p.id,name:p.name,price:p.price,size:document.getElementById("s"+id).value,qty:1});
  localStorage.setItem("cart",JSON.stringify(cart));
  updateCartCount();
}

function updateCartCount(){
  cartCount.textContent=cart.length;
}

function openCart(){
  renderCart();
  cartModal.style.display="flex";
}
function closeCart(){cartModal.style.display="none";}

function renderCart(){
  let total=0;
  cartItems.innerHTML="";
  cart.forEach(i=>{
    total+=i.price*i.qty;
    cartItems.innerHTML+=`<div class="cart-item">${i.name} (${i.size})</div>`;
  });
  cartTotal.textContent="Total $"+total;
}

function sendOrder(){
  // FIX: stock reduced only after order
  cart.forEach(item=>{
    const p=products.find(x=>x.id===item.id);
    if(p)p.stock-=item.qty;
  });
  localStorage.setItem("products",JSON.stringify(products));
  cart=[];
  localStorage.removeItem("cart");
  render();
  closeCart();
  window.open(`https://m.me/${PAGE_NAME}`);
}

function renderOrders(){
  orders.innerHTML="";
}

render();
if(adminUnlocked)adminBtn.style.display="inline-block";
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box;font-family:Segoe UI,system-ui}
body{margin:0;background:#f5f6f8}
header{background:#fff;padding:15px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.container{max-width:1200px;margin:auto;padding:20px}
.flex{display:flex;justify-content:space-between;align-items:center}
nav button{margin-left:10px;border:none;background:#eee;padding:8px 14px;border-radius:6px;cursor:pointer}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px}
.card{background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 4px 10px rgba(0,0,0,.1)}
.card img{width:100%;height:180px;object-fit:cover}
.card-body{padding:12px}
.price{color:#ff6b35;font-weight:bold}
.btn{padding:8px 14px;border:none;border-radius:6px;cursor:pointer}
.btn-orange{background:#ff6b35;color:#fff}
.btn-blue{background:#4a90e2;color:#fff}
.btn-red{background:#e74c3c;color:#fff}
.hidden{display:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center}
.modal-content{background:#fff;padding:20px;border-radius:10px;width:90%;max-width:420px}
input,textarea,select{width:100%;padding:8px;margin-bottom:8px}
.cart-item{display:flex;justify-content:space-between;margin-bottom:6px}
.preview{width:100%;height:160px;object-fit:cover;border-radius:6px;margin-bottom:8px}
.order{background:#fff;padding:10px;margin-bottom:10px;border-radius:6px}
</style>
</head>
<body>

<header>
<div class="container flex">
<b>ðŸ›’ My Store</b>
<nav>
<button onclick="openCart()">Cart (<span id="cartCount">0</span>)</button>
<button onclick="openAdmin()">Admin</button>
</nav>
</div>
</header>

<div class="container">

<!-- STORE -->
<section id="store">
<div class="grid" id="productGrid"></div>
</section>

<!-- ADMIN -->
<section id="admin" class="hidden">
<h2>Admin Panel</h2>
<input id="name" placeholder="Product name">
<input id="price" type="number" placeholder="Price">
<input id="stock" type="number" placeholder="Stock">
<input id="size" placeholder="Sizes (comma separated, e.g. S,M,L)">
<input type="file" id="image" accept="image/*">
<img id="preview" class="preview hidden">
<button class="btn btn-orange" onclick="addProduct()">Add Product</button>

<h3>Order History</h3>
<div id="orders"></div>
<button class="btn btn-red" onclick="logout()">Logout</button>
</section>

</div>

<!-- LOGIN -->
<div class="modal" id="loginModal">
<div class="modal-content">
<h3>Admin Login</h3>
<input id="user" value="admin">
<input id="pass" type="password" value="admin123">
<button class="btn btn-blue" onclick="login()">Login</button>
</div>
</div>

<!-- CART -->
<div class="modal" id="cartModal">
<div class="modal-content">
<h3>Your Cart</h3>
<div id="cartItems"></div>
<h4 id="cartTotal"></h4>

<h4>Customer Info</h4>
<input id="cname" placeholder="Full Name">
<input id="cphone" placeholder="Phone Number">
<textarea id="caddr" placeholder="Delivery Address"></textarea>

<p><b>Payment:</b><br>ðŸ’³ Pay online via <a id="payText" href="#" target="_blank"></a></p>

<button class="btn btn-orange" onclick="window.open(PAYWAY_LINK,'_blank')">ðŸ’³ Pay via PayWay</button>
<button class="btn btn-blue" onclick="sendOrder()">ðŸ“© Order via Messenger</button>
<button class="btn btn-red" onclick="closeCart()">Close</button>
</div>
</div>

<script>
const PAGE_NAME = "Goatkids";
const PAYWAY_LINK = "https://link.payway.com.kh/08407860s";
document.getElementById("payText").textContent = "Click here to pay";
document.getElementById("payText").href = PAYWAY_LINK;

let products = JSON.parse(localStorage.getItem("products")) || [];
let cart = JSON.parse(localStorage.getItem("cart")) || [];
let orders = JSON.parse(localStorage.getItem("orders")) || [];
let isAdmin = localStorage.getItem("admin")==="true";

const image = document.getElementById("image");
const preview = document.getElementById("preview");

image.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
        preview.src = reader.result;
        preview.classList.remove("hidden");
    };
    reader.readAsDataURL(file);
};

function resizeImage(base64, max=600){
    return new Promise(res=>{
        const img=new Image();
        img.onload=()=>{
            const scale=Math.min(max/img.width,max/img.height,1);
            const c=document.createElement("canvas");
            c.width=img.width*scale;
            c.height=img.height*scale;
            c.getContext("2d").drawImage(img,0,0,c.width,c.height);
            res(c.toDataURL("image/jpeg",0.8));
        };
        img.src=base64;
    });
}

function openAdmin(){
    if(!isAdmin){loginModal.style.display="flex";return;}
    store.classList.add("hidden");
    admin.classList.remove("hidden");
    renderOrders();
}

function login(){
    const user=document.getElementById("user");
    const pass=document.getElementById("pass");
    if(user.value==="admin"&&pass.value==="admin123"){
        isAdmin=true;
        localStorage.setItem("admin","true");
        loginModal.style.display="none";
        openAdmin();
    } else alert("Wrong login");
}

function logout(){
    isAdmin=false;
    localStorage.removeItem("admin");
    admin.classList.add("hidden");
    store.classList.remove("hidden");
}

async function addProduct(){
    const sizeInput = document.getElementById("size"); // FIX: size reference

    if(!image.files[0]) return alert("Select image");
    const base64 = await resizeImage(preview.src);

    const sizeValues = sizeInput.value.split(",").map(s => s.trim()).filter(s=>s);

    products.push({
        id: Date.now(),
        name: name.value,
        price: +price.value,
        stock: +stock.value,
        sizes: sizeValues,
        image: base64
    });

    localStorage.setItem("products",JSON.stringify(products));

    // Reset admin inputs
    name.value = price.value = stock.value = sizeInput.value = image.value = "";
    preview.classList.add("hidden");
    render();
}

function addToCart(id){
    const p = products.find(x=>x.id===id);
    const selectedSize = document.getElementById(`sizeSelect-${id}`).value || "N/A";

    const item = cart.find(i => i.id === id && i.size === selectedSize);

    if(item){
        item.qty++;
    } else {
        cart.push({
            id: p.id,
            name: p.name,
            price: p.price,
            size: selectedSize,
            qty: 1
        });
    }

    localStorage.setItem("cart",JSON.stringify(cart));
    updateCartCount();
}

function render(){
    productGrid.innerHTML="";
    products.forEach(p=>{
        let sizeOptions = p.sizes.map(s=>`<option value="${s}">${s}</option>`).join("");
        productGrid.innerHTML+=`
        <div class="card">
            <img src="${p.image}">
            <div class="card-body">
                <h4>${p.name}</h4>
                <div class="price">$${p.price}</div>
                <select id="sizeSelect-${p.id}">${sizeOptions}</select>
                <button class="btn btn-orange" onclick="addToCart(${p.id})">Add to Cart</button>
            </div>
        </div>`;
    });
    updateCartCount();
}

function updateCartCount(){
    cartCount.textContent = cart.reduce((s,i)=>s+i.qty,0);
}

function openCart(){
    renderCart();
    cartModal.style.display="flex";
}
function closeCart(){cartModal.style.display="none";}

function renderCart(){
    let t=0, h="";
    cart.forEach(i=>{
        t += i.price * i.qty;
        h += `<div class="cart-item"><span>${i.name} (${i.size}) x ${i.qty}</span><span>$${(i.price*i.qty).toFixed(2)}</span></div>`;
    });
    cartItems.innerHTML = h || "<p>Empty</p>";
    cartTotal.textContent = "Total: $"+t.toFixed(2);
}

function sendOrder(){
    const cname=document.getElementById("cname");
    const cphone=document.getElementById("cphone");
    const caddr=document.getElementById("caddr");
    if(!cname.value || !cphone.value || !caddr.value) return alert("Fill customer info");

    let msg=`ðŸ›’ New Order%0AðŸ‘¤ ${cname.value}%0AðŸ“ž ${cphone.value}%0AðŸ“ ${caddr.value}%0A%0A`;
    let total=0;
    cart.forEach(i=>{
        msg+=`${i.name} (${i.size}) x ${i.qty} = $${(i.price*i.qty).toFixed(2)}%0A`;
        total+=i.price*i.qty;
    });
    msg+=`%0AðŸ’° Total: $${total}%0AðŸ’³ Pay online: ${PAYWAY_LINK}`;

    orders.push({date:new Date().toLocaleString(),name:cname.value,phone:cphone.value,total,items:[...cart]});
    localStorage.setItem("orders",JSON.stringify(orders));

    window.open(`https://m.me/${PAGE_NAME}?text=${msg}`,"_blank");
    cart=[]; 
    localStorage.removeItem("cart");
    closeCart();
    renderOrders();
    updateCartCount();
}

function renderOrders(){
    const ordersDiv=document.getElementById("orders");
    ordersDiv.innerHTML="";
    orders.forEach(o=>{
        ordersDiv.innerHTML+=`
        <div class="order">
            <b>${o.date}</b><br>
            ${o.name} (${o.phone})<br>
            Total: $${o.total}
        </div>`;
    });
}

render();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* { box-sizing: border-box; font-family: Segoe UI, system-ui, sans-serif; }
body { margin: 0; background: #f5f6f8; }
header { background: #fff; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,.1); }
.container { max-width: 1200px; margin: auto; padding: 20px; }
.flex { display: flex; display: -ms-flexbox; justify-content: space-between; align-items: center; }
nav button { margin-left: 10px; border: none; background: #eee; padding: 8px 14px; border-radius: 6px; cursor: pointer; transition: background 0.3s; }
nav button:hover { background: #ddd; }
.grid { display: grid; display: -ms-grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; margin-top: 20px; }
.card { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 6px 15px rgba(0,0,0,.1); position: relative; transition: transform 0.3s, box-shadow 0.3s; }
.card:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0,0,0,.15); }
.card img { width: 100%; height: 250px; object-fit: cover; transition: transform 0.3s; }
.card:hover img { transform: scale(1.05); }
.card-body { padding: 15px; }
.price { color: #ff6b35; font-weight: bold; font-size: 1.3em; margin: 8px 0; }
.btn { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; margin-top: 8px; transition: all 0.3s; font-weight: 500; }
.btn:hover { opacity: 0.9; transform: translateY(-2px); }
.btn-orange { background: linear-gradient(135deg, #ff6b35, #ff8e53); color: #fff; }
.btn-blue { background: linear-gradient(135deg, #4a90e2, #6aa7f0); color: #fff; }
.btn-red { background: linear-gradient(135deg, #e74c3c, #ff6b5c); color: #fff; }
.btn-gray { background: linear-gradient(135deg, #95a5a6, #b4c0c1); color: #fff; }
.btn-green { background: linear-gradient(135deg, #27ae60, #2ecc71); color: #fff; }
.hidden { display: none !important; }
.modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
input, textarea, select { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
input:focus, textarea:focus, select:focus { outline: none; border-color: #4a90e2; box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1); }
.cart-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 12px; border-bottom: 1px solid #eee; }
.preview { width: 100%; height: 200px; object-fit: contain; border-radius: 8px; margin-bottom: 12px; border: 1px solid #eee; background: #f8f9fa; }
.order { background: #fff; padding: 15px; margin-bottom: 12px; border-radius: 8px; border-left: 4px solid #4a90e2; }
.alert-stock { color: #e74c3c; font-weight: bold; margin-top: 8px; padding: 5px; background: #fee; border-radius: 4px; text-align: center; }
.edit-btn { background: #4a90e2; color: #fff; width: 100%; margin-top: 8px; }
.form-group { margin-bottom: 18px; }
.form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #333; }
.alert { padding: 12px; border-radius: 6px; margin-bottom: 12px; }
.alert-error { background: linear-gradient(135deg, #fee, #fdd); color: #c33; border: 1px solid #fcc; }
.alert-success { background: linear-gradient(135deg, #efe, #dfd); color: #393; border: 1px solid #cfc; }
.password-section { background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; margin: 25px 0; border: 1px solid #dee2e6; }
.product-sizes { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0; }
.size-tag { padding: 4px 12px; background: #f0f0f0; border-radius: 20px; font-size: 13px; }
.size-select { padding: 8px; border-radius: 6px; border: 1px solid #ddd; background: #fff; margin-top: 10px; }
.image-upload-container { border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 15px; background: #fafafa; }
.image-upload-container:hover { border-color: #4a90e2; }
.image-upload-label { display: block; cursor: pointer; color: #666; }
.image-upload-label:hover { color: #4a90e2; }
.image-upload-icon { font-size: 40px; margin-bottom: 10px; }
/* Secret admin access area - invisible */
.secret-admin-area { 
    position: fixed; 
    top: 0; 
    right: 0; 
    width: 100px; 
    height: 40px; 
    background: transparent; 
    z-index: 10000; 
    cursor: pointer; 
}
</style>
</head>
<body>

<!-- Secret admin unlock area -->
<div class="secret-admin-area" onclick="unlockAdmin()" title="Click to unlock admin"></div>

<header>
<div class="container flex">
<b>ðŸ›’ My Store</b>
<nav>
<button onclick="openCart()">Cart (<span id="cartCount">0</span>)</button>
<button id="adminBtn" onclick="openAdmin()" style="display:none;">Admin</button>
</nav>
</div>
</header>

<div class="container">

<section id="store">
<div class="grid" id="productGrid"></div>
</section>

<section id="admin" class="hidden">
<h2>Admin Panel</h2>

<div class="form-group">
<label for="name">Product Name</label>
<input id="name" placeholder="Enter product name">
</div>
<div class="form-group">
<label for="price">Price ($)</label>
<input id="price" type="number" min="0" step="0.01" placeholder="0.00">
</div>
<div class="form-group">
<label for="stock">Stock Quantity</label>
<input id="stock" type="number" min="0" placeholder="0">
</div>
<div class="form-group">
<label for="size">Sizes (comma separated)</label>
<input id="size" placeholder="S, M, L, XL">
</div>
<div class="form-group">
<label>Product Image</label>
<div class="image-upload-container">
<div class="image-upload-label" onclick="document.getElementById('image').click()">
<div class="image-upload-icon">ðŸ“·</div>
Click to upload image or drag & drop<br><small>800x800px max 5MB</small>
</div>
<input type="file" id="image" accept="image/*" style="display:none;">
<div id="imageError" class="alert alert-error hidden"></div>
</div>
</div>
<img id="preview" class="preview hidden">
<div class="flex">
<button id="saveProductBtn" class="btn btn-orange" onclick="saveProduct()">Add Product</button>
<button id="cancelEditBtn" class="btn btn-gray hidden" onclick="cancelEdit()" style="margin-left:10px;">Cancel Edit</button>
</div>

<!-- Password Change -->
<div class="password-section">
<h3>Change Admin Password</h3>
<div id="passwordMessage" class="alert hidden"></div>
<div class="form-group"><label>Old Password</label><input id="oldPass" type="password"></div>
<div class="form-group"><label>New Password</label><input id="newPass" type="password"></div>
<div class="form-group"><label>Confirm New Password</label><input id="confirmPass" type="password"></div>
<button class="btn btn-green" onclick="changePassword()">Change Password</button>
</div>

<h3>Order History</h3>
<div id="orders"></div>

<h3>Edit Products</h3>
<div id="editProducts"></div>
<button class="btn btn-red" onclick="logout()" style="margin-top:20px;">Logout</button>
</section>

</div>

<!-- Login Modal -->
<div class="modal" id="loginModal">
<div class="modal-content">
<h3>Admin Login</h3>
<div class="form-group"><label>Username</label><input id="user" value="admin"></div>
<div class="form-group"><label>Password</label><input id="pass" type="password"></div>
<button class="btn btn-blue" onclick="login()">Login</button>
</div>
</div>

<!-- Cart Modal -->
<div class="modal" id="cartModal">
<div class="modal-content">
<h3>Your Cart</h3>
<div id="cartItems"></div>
<h4 id="cartTotal"></h4>
<h4>Customer Info</h4>
<div class="form-group"><label>Full Name</label><input id="cname"></div>
<div class="form-group"><label>Phone Number</label><input id="cphone"></div>
<div class="form-group"><label>Delivery Address</label><textarea id="caddr" rows="3"></textarea></div>
<div class="form-group"><p><b>Payment:</b> <a id="payText" href="#" target="_blank">PayWay</a></p></div>
<div class="flex">
<button class="btn btn-orange" onclick="payViaPayWay()">ðŸ’³ Pay via PayWay</button>
<button class="btn btn-blue" onclick="sendOrder()">ðŸ“© Order via Messenger</button>
<button class="btn btn-red" onclick="closeCart()">Close</button>
</div>
</div>
</div>

<script>
// Cross-browser localStorage
function getStorage(key){try{return JSON.parse(localStorage.getItem(key))||[];}catch(e){return[];}}
function setStorage(key,value){try{localStorage.setItem(key,JSON.stringify(value));}catch(e){console.warn("LocalStorage not available");}}

// Global
const productGrid = document.getElementById("productGrid");
const cartCount = document.getElementById("cartCount");
const store = document.getElementById("store");
const admin = document.getElementById("admin");
const loginModal = document.getElementById("loginModal");
const cartModal = document.getElementById("cartModal");
const editProductsDiv = document.getElementById("editProducts");
const imageInput = document.getElementById("image");
const preview = document.getElementById("preview");
const imageError = document.getElementById("imageError");
const saveProductBtn = document.getElementById("saveProductBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const passwordMessage = document.getElementById("passwordMessage");
const adminBtn = document.getElementById("adminBtn");

const PAYWAY_LINK = "https://link.payway.com.kh/08407860s";
const PAGE_NAME = "Goatkids";
const SECRET_UNLOCK_PASSWORD = "admin123";

let products = getStorage("products");
let cart = getStorage("cart");
let orders = getStorage("orders");
let isAdmin = localStorage.getItem("admin")==="true";
let adminUnlocked = localStorage.getItem("adminUnlocked")==="true";
let currentEditId=null;
let currentImageData=null;

// Init default password
if(!localStorage.getItem("adminPassword")){localStorage.setItem("adminPassword","admin123");}
document.getElementById("payText").textContent="PayWay";
document.getElementById("payText").href=PAYWAY_LINK;

// SECRET ADMIN UNLOCK
function unlockAdmin(){
    const pass=prompt("Enter admin unlock password:");
    if(pass===SECRET_UNLOCK_PASSWORD){adminUnlocked=true;localStorage.setItem("adminUnlocked","true");adminBtn.style.display="inline-block";alert("Admin unlocked!");}
    else if(pass){alert("Incorrect password!");}
}

// Image upload
imageInput.onchange = function(e){
    const file = e.target.files[0]; if(!file) return;
    imageError.classList.add("hidden");
    if(!file.type.startsWith("image/")){showImageError("Select an image file"); return;}
    if(file.size>5*1024*1024){showImageError("Max 5MB"); return;}
    const reader=new FileReader();
    reader.onload=function(){const img=new Image();img.onload=function(){preview.src=reader.result;preview.classList.remove("hidden");resizeImage(reader.result,800,800).then(data=>{currentImageData=data;});}; img.src=reader.result;};
    reader.readAsDataURL(file);
};
function showImageError(msg){imageError.textContent=msg; imageError.classList.remove("hidden"); imageInput.value=""; preview.classList.add("hidden"); currentImageData=null;}
function resizeImage(base64,maxW,maxH){return new Promise(resolve=>{const img=new Image();img.onload=function(){let w=img.width,h=img.height; if(w>maxW){h=Math.round(h*maxW/w); w=maxW;} if(h>maxH){w=Math.round(w*maxH/h); h=maxH;} const canvas=document.createElement("canvas");canvas.width=w;canvas.height=h; const ctx=canvas.getContext("2d"); ctx.imageSmoothingEnabled=true;ctx.imageSmoothingQuality='high'; ctx.drawImage(img,0,0,w,h); resolve(canvas.toDataURL("image/jpeg",0.85));}; img.src=base64;});}

// Drag & drop
document.addEventListener("DOMContentLoaded",function(){const c=document.querySelector(".image-upload-container"); if(!c) return; ["dragenter","dragover","dragleave","drop"].forEach(e=>{c.addEventListener(e,prevent,false);document.body.addEventListener(e,prevent,false);}); ["dragenter","dragover"].forEach(e=>c.addEventListener(e,()=>{c.style.borderColor="#4a90e2";c.style.background="#e8f4ff";},false)); ["dragleave","drop"].forEach(e=>c.addEventListener(e,()=>{c.style.borderColor="#ddd";c.style.background="#fafafa";},false)); c.addEventListener("drop",handleDrop,false); function prevent(e){e.preventDefault(); e.stopPropagation();} function handleDrop(e){const f=e.dataTransfer.files;if(f.length>0){imageInput.files=f; imageInput.dispatchEvent(new Event("change",{bubbles:true}));}}});

// ADMIN FUNCTIONS
function openAdmin(){if(!adminUnlocked){unlockAdmin(); return;} if(!isAdmin){loginModal.style.display="flex"; return;} store.classList.add("hidden"); admin.classList.remove("hidden"); renderOrders(); renderEditProducts(); resetForm();}
function login(){const u=document.getElementById("user").value; const p=document.getElementById("pass").value; const pw=localStorage.getItem("adminPassword"); if(u==="admin" && p===pw){isAdmin=true; localStorage.setItem("admin","true"); loginModal.style.display="none"; openAdmin();} else alert("Invalid username or password");}
function logout(){isAdmin=false; localStorage.removeItem("admin"); admin.classList.add("hidden"); store.classList.remove("hidden"); resetForm();}

// PASSWORD CHANGE
function changePassword(){const oldP=document.getElementById("oldPass").value,newP=document.getElementById("newPass").value,confP=document.getElementById("confirmPass").value,pw=localStorage.getItem("adminPassword");passwordMessage.classList.add("hidden"); if(!oldP||!newP||!confP){showPasswordMessage("Fill all fields","error");return;} if(oldP!==pw){showPasswordMessage("Old password incorrect","error");return;} if(newP!==confP){showPasswordMessage("Passwords don't match","error");return;} if(newP.length<4){showPasswordMessage("Min 4 chars","error");return;} localStorage.setItem("adminPassword",newP); document.getElementById("oldPass").value=""; document.getElementById("newPass").value=""; document.getElementById("confirmPass").value=""; showPasswordMessage("Password changed!","success");}
function showPasswordMessage(msg,type){passwordMessage.textContent=msg; passwordMessage.className="alert "+(type==="error"?"alert-error":"alert-success"); passwordMessage.classList.remove("hidden");}

// PRODUCT FUNCTIONS
function saveProduct(){const name=document.getElementById("name").value.trim(),price=parseFloat(document.getElementById("price").value),stock=parseInt(document.getElementById("stock").value),size=document.getElementById("size").value.split(",").map(s=>s.trim()).filter(s=>s); if(!name||isNaN(price)||isNaN(stock)||!size.length||!currentImageData){alert("Fill all fields + image"); return;} if(currentEditId!==null){const p=products.find(x=>x.id===currentEditId); Object.assign(p,{name,price,stock,sizes:size,image:currentImageData}); currentEditId=null; saveProducts(); cancelEdit();} else{products.push({id:Date.now(),name,price,stock,sizes:size,image:currentImageData}); saveProducts(); resetForm();} renderProducts(); renderEditProducts(); }
function cancelEdit(){currentEditId=null; resetForm(); saveProductBtn.textContent="Add Product"; cancelEditBtn.classList.add("hidden");}
function resetForm(){document.getElementById("name").value=""; document.getElementById("price").value=""; document.getElementById("stock").value=""; document.getElementById("size").value=""; imageInput.value=""; preview.classList.add("hidden"); currentImageData=null; imageError.classList.add("hidden");}
function renderProducts(){productGrid.innerHTML=""; products.forEach(p=>{const div=document.createElement("div"); div.className="card"; div.innerHTML=`<img src="${p.image}"><div class="card-body"><b>${p.name}</b><div class="price">$${p.price.toFixed(2)}</div><div>Stock: ${p.stock}</div><div class="product-sizes">${p.sizes.map(s=>`<span class="size-tag">${s}</span>`).join("")}</div><button class="btn btn-blue" onclick="addToCart(${p.id})">Add to Cart</button></div>`; productGrid.appendChild(div);}); updateCartCount();}
function saveProducts(){setStorage("products",products);}

// EDIT PRODUCTS
function renderEditProducts(){editProductsDiv.innerHTML=""; products.forEach(p=>{const div=document.createElement("div"); div.className="order"; div.innerHTML=`<b>${p.name}</b> - $${p.price.toFixed(2)} - Stock: ${p.stock} <button class="btn edit-btn" onclick="editProduct(${p.id})">Edit</button> <button class="btn btn-red" onclick="deleteProduct(${p.id})">Delete</button>`; editProductsDiv.appendChild(div);});}
function editProduct(id){const p=products.find(x=>x.id===id); document.getElementById("name").value=p.name; document.getElementById("price").value=p.price; document.getElementById("stock").value=p.stock; document.getElementById("size").value=p.sizes.join(", "); preview.src=p.image; preview.classList.remove("hidden"); currentImageData=p.image; currentEditId=id; saveProductBtn.textContent="Save Changes"; cancelEditBtn.classList.remove("hidden");}
function deleteProduct(id){if(confirm("Delete product?")){products=products.filter(x=>x.id!==id); saveProducts(); renderProducts(); renderEditProducts();}}

// CART FUNCTIONS
function addToCart(id){const p=products.find(x=>x.id===id); if(!p||p.stock<=0){alert("Out of stock"); return;} const item=cart.find(x=>x.id===id); if(item){if(item.qty<p.stock)item.qty++; else{alert("Stock limit reached"); return;}}else{cart.push({id:id,qty:1});} setStorage("cart",cart); updateCartCount(); alert("Added to cart");}
function updateCartCount(){cartCount.textContent=cart.reduce((a,b)=>a+b.qty,0);}
function openCart(){renderCart(); cartModal.style.display="flex";}
function closeCart(){cartModal.style.display="none";}
function renderCart(){const itemsDiv=document.getElementById("cartItems"); const totalDiv=document.getElementById("cartTotal"); itemsDiv.innerHTML=""; let total=0; cart.forEach(ci=>{const p=products.find(x=>x.id===ci.id); if(!p) return; const div=document.createElement("div"); div.className="cart-item"; div.innerHTML=`${p.name} x ${ci.qty} - $${(p.price*ci.qty).toFixed(2)}`; itemsDiv.appendChild(div); total+=p.price*ci.qty;}); totalDiv.textContent="Total: $"+total.toFixed(2);}

// PAYWAY / MESSENGER
function payViaPayWay(){window.open(PAYWAY_LINK,"_blank");}
function sendOrder(){const name=document.getElementById("cname").value.trim(),phone=document.getElementById("cphone").value.trim(),addr=document.getElementById("caddr").value.trim(); if(!name||!phone||!addr){alert("Fill customer info"); return;} let msg=`Order from ${name}\nPhone: ${phone}\nAddress: ${addr}\n\nItems:\n`; cart.forEach(ci=>{const p=products.find(x=>x.id===ci.id); if(!p) return; msg+=`${p.name} x ${ci.qty} - $${(p.price*ci.qty).toFixed(2)}\n`;}); msg+=`\nTotal: $${cart.reduce((a,b)=>{const p=products.find(x=>x.id===b.id); return a+(p?p.price*b.qty:0);},0).toFixed(2)}`; window.open(`https://www.facebook.com/messages/t/${PAGE_NAME}?message=${encodeURIComponent(msg)}`,"_blank"); saveOrder(name,phone,addr,cart,total); cart=[]; setStorage("cart",cart); closeCart(); updateCartCount();}
function saveOrder(name,phone,addr,cart,total){orders.push({id:Date.now(),name,phone,addr,cart:JSON.parse(JSON.stringify(cart)),total}); setStorage("orders",orders); renderOrders();}
function renderOrders(){const ordersDiv=document.getElementById("orders"); ordersDiv.innerHTML=""; orders.forEach(o=>{const div=document.createElement("div"); div.className="order"; div.innerHTML=`<b>${o.name}</b> - $${o.total.toFixed(2)}<br>Phone: ${o.phone}<br>Address: ${o.addr}<br>Items:<br>${o.cart.map(c=>{const p=products.find(x=>x.id===c.id); return p?`${p.name} x ${c.qty}`:"";}).join("<br>")}`; ordersDiv.appendChild(div);});}

// INIT
renderProducts();
if(adminUnlocked) adminBtn.style.display="inline-block";
</script>

</body>
</html>

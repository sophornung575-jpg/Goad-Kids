<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* { box-sizing: border-box; font-family: Segoe UI, system-ui, sans-serif; }
body { margin: 0; background: #f5f6f8; }
header { background: #fff; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,.1); }
.container { max-width: 1200px; margin: auto; padding: 20px; }
.flex { display: flex; justify-content: space-between; align-items: center; }
nav button { margin-left: 10px; border: none; background: #eee; padding: 8px 14px; border-radius: 6px; cursor: pointer; transition: background 0.3s; }
nav button:hover { background: #ddd; }
.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; margin-top: 20px; }
.card { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 6px 15px rgba(0,0,0,.1); position: relative; transition: transform 0.3s, box-shadow 0.3s; }
.card:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0,0,0,.15); }
.card img { width: 100%; height: 250px; object-fit: cover; transition: transform 0.3s; }
.card:hover img { transform: scale(1.05); }
.card-body { padding: 15px; }
.price { color: #ff6b35; font-weight: bold; font-size: 1.3em; margin: 8px 0; }
.btn { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; margin-top: 8px; transition: all 0.3s; font-weight: 500; }
.btn:hover { opacity: 0.9; transform: translateY(-2px); }
.btn-orange { background: linear-gradient(135deg, #ff6b35, #ff8e53); color: #fff; }
.btn-blue { background: linear-gradient(135deg, #4a90e2, #6aa7f0); color: #fff; }
.btn-red { background: linear-gradient(135deg, #e74c3c, #ff6b5c); color: #fff; }
.btn-gray { background: linear-gradient(135deg, #95a5a6, #b4c0c1); color: #fff; }
.btn-green { background: linear-gradient(135deg, #27ae60, #2ecc71); color: #fff; }
.hidden { display: none !important; }
.modal { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
input, textarea, select { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
input:focus, textarea:focus, select:focus { outline: none; border-color: #4a90e2; box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1); }
.cart-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 12px; border-bottom: 1px solid #eee; }
.preview { width: 100%; height: 200px; object-fit: contain; border-radius: 8px; margin-bottom: 12px; border: 1px solid #eee; background: #f8f9fa; }
.order { background: #fff; padding: 15px; margin-bottom: 12px; border-radius: 8px; border-left: 4px solid #4a90e2; }
.alert-stock { color: #e74c3c; font-weight: bold; margin-top: 8px; padding: 5px; background: #fee; border-radius: 4px; text-align: center; }
.edit-btn { background: #4a90e2; color: #fff; width: 100%; margin-top: 8px; }
.form-group { margin-bottom: 18px; }
.form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #333; }
.alert { padding: 12px; border-radius: 6px; margin-bottom: 12px; }
.alert-error { background: linear-gradient(135deg, #fee, #fdd); color: #c33; border: 1px solid #fcc; }
.alert-success { background: linear-gradient(135deg, #efe, #dfd); color: #393; border: 1px solid #cfc; }
.password-section { background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; margin: 25px 0; border: 1px solid #dee2e6; }
.product-sizes { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0; }
.size-tag { padding: 4px 12px; background: #f0f0f0; border-radius: 20px; font-size: 13px; }
.size-select { padding: 8px; border-radius: 6px; border: 1px solid #ddd; background: #fff; margin-top: 10px; }
.image-upload-container { border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 15px; background: #fafafa; }
.image-upload-container:hover { border-color: #4a90e2; }
.image-upload-label { display: block; cursor: pointer; color: #666; }
.image-upload-label:hover { color: #4a90e2; }
.image-upload-icon { font-size: 40px; margin-bottom: 10px; }
/* Secret admin access area - invisible */
.secret-admin-area { 
    position: fixed; 
    top: 0; 
    right: 0; 
    width: 100px; 
    height: 40px; 
    background: transparent; 
    z-index: 10000; 
    cursor: pointer; 
}
/* FIXED CSS RULES FOR VISIBILITY */
#store {
    display: block !important;
}
#admin.hidden, #store.hidden {
    display: none !important;
}
</style>
</head>
<body>

<!-- Secret admin unlock area (invisible in top-right corner) -->
<div class="secret-admin-area" onclick="unlockAdmin()" title="Click to unlock admin"></div>

<header>
<div class="container flex">
<b>üõí My Store</b>
<nav>
<button onclick="openCart()">Cart (<span id="cartCount">0</span>)</button>
<button id="adminBtn" onclick="openAdmin()" style="display: none;">Admin</button>
<button onclick="forceRefresh()" style="background: #ff6b35; color: white;">üîÑ Refresh</button>
</nav>
</div>
</header>

<div class="container">

<!-- STORE -->
<section id="store">
<div class="grid" id="productGrid"></div>
</section>

<!-- ADMIN -->
<section id="admin" class="hidden">
<h2>Admin Panel</h2>
<div class="form-group">
<label for="name">Product Name</label>
<input id="name" placeholder="Enter product name">
</div>
<div class="form-group">
<label for="price">Price ($)</label>
<input id="price" type="number" min="0" step="0.01" placeholder="0.00">
</div>
<div class="form-group">
<label for="stock">Stock Quantity</label>
<input id="stock" type="number" min="0" placeholder="0">
</div>
<div class="form-group">
<label for="size">Sizes (comma separated)</label>
<input id="size" placeholder="S, M, L, XL">
</div>
<div class="form-group">
<label>Product Image</label>
<div class="image-upload-container">
<div class="image-upload-label" onclick="document.getElementById('image').click()">
<div class="image-upload-icon">üì∑</div>
Click to upload image or drag & drop
<br><small>Recommended: 800x800px, max 5MB</small>
</div>
<input type="file" id="image" accept="image/*" style="display: none;">
<div id="imageError" class="alert alert-error hidden"></div>
</div>
</div>
<img id="preview" class="preview hidden">
<div class="flex">
<button id="saveProductBtn" class="btn btn-orange" onclick="saveProduct()">Add Product</button>
<button id="cancelEditBtn" class="btn btn-gray hidden" onclick="cancelEdit()" style="margin-left: 10px;">Cancel Edit</button>
</div>

<!-- PASSWORD CHANGE SECTION -->
<div class="password-section">
<h3>Change Admin Password</h3>
<div id="passwordMessage" class="alert hidden"></div>
<div class="form-group">
<label for="oldPass">Old Password</label>
<input type="password" id="oldPass" placeholder="Enter old password">
</div>
<div class="form-group">
<label for="newPass">New Password</label>
<input type="password" id="newPass" placeholder="Enter new password (min 4 chars)">
</div>
<div class="form-group">
<label for="confirmPass">Confirm New Password</label>
<input type="password" id="confirmPass" placeholder="Confirm new password">
</div>
<button class="btn btn-green" onclick="changePassword()">Change Password</button>
</div>

<h3>Order History</h3>
<div id="orders"></div>

<h3>Edit Products</h3>
<div id="editProducts"></div>

<button class="btn btn-blue" onclick="showStore()" style="margin-right: 10px;">View Store</button>
<button class="btn btn-red" onclick="logout()">Logout</button>
</section>

</div>

<!-- LOGIN MODAL -->
<div class="modal" id="loginModal">
<div class="modal-content">
<h3>Admin Login</h3>
<div class="form-group">
<label for="user">Username</label>
<input id="user" value="admin">
</div>
<div class="form-group">
<label for="pass">Password</label>
<input id="pass" type="password" placeholder="Enter password">
</div>
<button class="btn btn-blue" onclick="login()">Login</button>
</div>
</div>

<!-- CART MODAL -->
<div class="modal" id="cartModal">
<div class="modal-content">
<h3>Your Cart</h3>
<div id="cartItems"></div>
<h4 id="cartTotal"></h4>

<h4>Customer Information</h4>
<div class="form-group">
<label for="cname">Full Name</label>
<input id="cname" placeholder="Enter your full name">
</div>
<div class="form-group">
<label for="cphone">Phone Number</label>
<input id="cphone" placeholder="Enter phone number">
</div>
<div class="form-group">
<label for="caddr">Delivery Address</label>
<textarea id="caddr" placeholder="Enter delivery address" rows="3"></textarea>
</div>

<div class="form-group">
<p><b>Payment Method:</b></p>
<p>üí≥ Pay online via <a id="payText" href="#" target="_blank">PayWay</a></p>
</div>

<div class="flex">
<button class="btn btn-orange" onclick="payViaPayWay()">üí≥ Pay via PayWay</button>
<button class="btn btn-blue" onclick="sendOrder()">üì© Order via Messenger</button>
<button class="btn btn-red" onclick="closeCart()">Close</button>
</div>
</div>
</div>

<script>
// Global Variables
const productGrid = document.getElementById("productGrid");
const cartCount = document.getElementById("cartCount");
const store = document.getElementById("store");
const admin = document.getElementById("admin");
const loginModal = document.getElementById("loginModal");
const cartModal = document.getElementById("cartModal");
const editProductsDiv = document.getElementById("editProducts");
const imageInput = document.getElementById("image");
const preview = document.getElementById("preview");
const imageError = document.getElementById("imageError");
const saveProductBtn = document.getElementById("saveProductBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const passwordMessage = document.getElementById("passwordMessage");
const adminBtn = document.getElementById("adminBtn");

const PAYWAY_LINK = "https://link.payway.com.kh/08407860s";
const PAGE_NAME = "Goatkids";
const SECRET_UNLOCK_PASSWORD = "admin123";

// Load data from localStorage
function loadData() {
    products = JSON.parse(localStorage.getItem("products")) || [];
    cart = JSON.parse(localStorage.getItem("cart")) || [];
    orders = JSON.parse(localStorage.getItem("orders")) || [];
    isAdmin = localStorage.getItem("admin") === "true";
    adminUnlocked = localStorage.getItem("adminUnlocked") === "true";
    console.log("Data loaded. Products:", products.length);
}

// Initialize variables
let products = [], cart = [], orders = [];
let isAdmin = false, adminUnlocked = false;
let currentEditId = null;
let currentImageData = null;

// Initialize admin credentials if not set
if (!localStorage.getItem("adminPassword")) {
    localStorage.setItem("adminPassword", "admin123");
}

// Initialize
loadData();
document.getElementById("payText").textContent = "PayWay";
document.getElementById("payText").href = PAYWAY_LINK;

// Helper function to force refresh
function forceRefresh() {
    loadData();
    render();
    alert(`Refreshed! Found ${products.length} products`);
}

// Secret Admin Unlock Function
function unlockAdmin() {
    const password = prompt("Enter admin unlock password:");
    
    if (password === SECRET_UNLOCK_PASSWORD) {
        adminUnlocked = true;
        localStorage.setItem("adminUnlocked", "true");
        adminBtn.style.display = "inline-block";
        alert("‚úì Admin access unlocked! Admin button is now visible.");
    } else if (password) {
        alert("‚úó Incorrect password!");
    }
}

// View switching functions
function showStore() {
    loadData();
    admin.classList.add("hidden");
    store.classList.remove("hidden");
    render();
}

function showAdmin() {
    store.classList.add("hidden");
    admin.classList.remove("hidden");
    renderOrders();
    renderEditProducts();
}

// Image Handling
imageInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    imageError.classList.add("hidden");
    
    if (!file.type.startsWith('image/')) {
        showImageError("Please select an image file (JPEG, PNG, etc.)");
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        showImageError("Image too large! Maximum size is 5MB");
        return;
    }
    
    const reader = new FileReader();
    reader.onload = async () => {
        const img = new Image();
        img.onload = async () => {
            if (img.width < 400 || img.height < 400) {
                imageError.textContent = `Image is small (${img.width}x${img.height}px). For best quality, use images at least 800x800px.`;
                imageError.classList.remove("hidden");
                imageError.style.color = "#e67e22";
                imageError.style.background = "#fff4e6";
            }
            
            preview.src = reader.result;
            preview.classList.remove("hidden");
            
            currentImageData = await resizeImage(reader.result, 800, 800);
        };
        img.src = reader.result;
    };
    reader.readAsDataURL(file);
};

function showImageError(message) {
    imageError.textContent = message;
    imageError.classList.remove("hidden");
    imageError.style.color = "#c33";
    imageError.style.background = "#fee";
    imageInput.value = "";
    preview.classList.add("hidden");
    currentImageData = null;
}

// Enhanced resize function with aspect ratio preservation
async function resizeImage(base64, maxWidth = 800, maxHeight = 800) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
                height = Math.round(height * maxWidth / width);
                width = maxWidth;
            }
            
            if (height > maxHeight) {
                width = Math.round(width * maxHeight / height);
                height = maxHeight;
            }
            
            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext("2d");
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(img, 0, 0, width, height);
            
            resolve(canvas.toDataURL("image/jpeg", 0.85));
        };
        img.src = base64;
    });
}

// Admin Functions
function openAdmin() {
    if (!adminUnlocked) {
        unlockAdmin();
        return;
    }
    
    if (!isAdmin) {
        loginModal.style.display = "flex";
        return;
    }
    showAdmin();
}

function login() {
    const user = document.getElementById("user").value;
    const pass = document.getElementById("pass").value;
    const storedPassword = localStorage.getItem("adminPassword");
    
    if (user === "admin" && pass === storedPassword) {
        isAdmin = true;
        localStorage.setItem("admin", "true");
        loginModal.style.display = "none";
        openAdmin();
    } else {
        alert("Invalid username or password");
    }
}

function logout() {
    isAdmin = false;
    localStorage.removeItem("admin");
    admin.classList.add("hidden");
    store.classList.remove("hidden");
    resetForm();
    loadData();
    render();
}

// Password Change Function
function changePassword() {
    const oldPass = document.getElementById("oldPass").value;
    const newPass = document.getElementById("newPass").value;
    const confirmPass = document.getElementById("confirmPass").value;
    const storedPassword = localStorage.getItem("adminPassword");
    
    passwordMessage.classList.add("hidden");
    
    if (!oldPass || !newPass || !confirmPass) {
        showPasswordMessage("Please fill in all fields", "error");
        return;
    }
    
    if (oldPass !== storedPassword) {
        showPasswordMessage("Old password is incorrect", "error");
        return;
    }
    
    if (newPass !== confirmPass) {
        showPasswordMessage("New passwords don't match", "error");
        return;
    }
    
    if (newPass.length < 4) {
        showPasswordMessage("New password must be at least 4 characters long", "error");
        return;
    }
    
    localStorage.setItem("adminPassword", newPass);
    
    document.getElementById("oldPass").value = "";
    document.getElementById("newPass").value = "";
    document.getElementById("confirmPass").value = "";
    
    showPasswordMessage("Password changed successfully!", "success");
}

function showPasswordMessage(message, type) {
    passwordMessage.textContent = message;
    passwordMessage.className = "alert";
    passwordMessage.classList.remove("hidden");
    
    if (type === "success") {
        passwordMessage.classList.add("alert-success");
    } else {
        passwordMessage.classList.add("alert-error");
    }
    
    if (type === "success") {
        setTimeout(() => {
            passwordMessage.classList.add("hidden");
        }, 3000);
    }
}

// Product Management
async function saveProduct() {
    const name = document.getElementById("name").value.trim();
    const price = parseFloat(document.getElementById("price").value);
    const stock = parseInt(document.getElementById("stock").value);
    const size = document.getElementById("size").value;
    
    if (!name) {
        alert("Product name is required");
        return;
    }
    
    if (isNaN(price) || price < 0) {
        alert("Please enter a valid price (minimum 0)");
        return;
    }
    
    if (isNaN(stock) || stock < 0) {
        alert("Please enter a valid stock quantity (minimum 0)");
        return;
    }
    
    if (currentEditId === null && !currentImageData) {
        alert("Please select an image for the new product");
        return;
    }
    
    const sizeValues = size.split(",").map(s => s.trim()).filter(s => s);
    
    if (currentEditId !== null) {
        const product = products.find(p => p.id === currentEditId);
        if (product) {
            product.name = name;
            product.price = price;
            product.stock = stock;
            product.sizes = sizeValues;
            if (currentImageData) product.image = currentImageData;
        }
    } else {
        const newProduct = {
            id: Date.now(),
            name: name,
            price: price,
            stock: stock,
            sizes: sizeValues,
            image: currentImageData
        };
        products.push(newProduct);
    }
    
    localStorage.setItem("products", JSON.stringify(products));
    loadData();
    resetForm();
    renderEditProducts();
    alert(currentEditId !== null ? "Product updated successfully!" : "Product added successfully!\n\nClick 'View Store' button to see your products.");
}

// DELETE PRODUCT FUNCTION
function deleteProduct(id) {
    if (!confirm("Are you sure you want to delete this product? This action cannot be undone.")) {
        return;
    }
    
    let productInCart = false;
    cart.forEach(item => {
        if (item.id === id) {
            productInCart = true;
        }
    });
    
    if (productInCart) {
        if (!confirm("This product is currently in someone's cart. Deleting it will remove it from all carts. Continue?")) {
            return;
        }
        cart = cart.filter(item => item.id !== id);
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartCount();
    }
    
    const initialLength = products.length;
    products = products.filter(p => p.id !== id);
    
    if (products.length < initialLength) {
        localStorage.setItem("products", JSON.stringify(products));
        loadData();
        renderEditProducts();
        alert("Product deleted successfully!");
        
        if (currentEditId === id) {
            resetForm();
        }
    } else {
        alert("Product not found!");
    }
}

function editProduct(id) {
    const product = products.find(p => p.id === id);
    if (!product) return;
    
    document.getElementById("name").value = product.name;
    document.getElementById("price").value = product.price;
    document.getElementById("stock").value = product.stock;
    document.getElementById("size").value = product.sizes.join(", ");
    
    if (product.image) {
        preview.src = product.image;
        preview.classList.remove("hidden");
        currentImageData = product.image;
    }
    
    currentEditId = id;
    saveProductBtn.textContent = "Update Product";
    saveProductBtn.className = "btn btn-blue";
    cancelEditBtn.classList.remove("hidden");
}

function resetForm() {
    document.getElementById("name").value = "";
    document.getElementById("price").value = "";
    document.getElementById("stock").value = "";
    document.getElementById("size").value = "";
    imageInput.value = "";
    preview.src = "";
    preview.classList.add("hidden");
    imageError.classList.add("hidden");
    currentEditId = null;
    currentImageData = null;
    saveProductBtn.textContent = "Add Product";
    saveProductBtn.className = "btn btn-orange";
    cancelEditBtn.classList.add("hidden");
}

function cancelEdit() {
    resetForm();
}

// Enhanced Render Products with better image display - FIXED
function render() {
    console.log("Rendering products...", products);
    productGrid.innerHTML = "";
    
    if (!products || products.length === 0) {
        productGrid.innerHTML = `
            <div style="text-align: center; grid-column: 1/-1; padding: 60px 20px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,.05);">
                <div style="font-size: 60px; margin-bottom: 20px;">üõçÔ∏è</div>
                <h3 style="color: #666; margin-bottom: 10px;">No Products Available</h3>
                <p style="color: #999; margin-bottom: 20px;">Add some products in the admin panel to get started!</p>
                <button class="btn btn-blue" onclick="openAdmin()">Go to Admin Panel</button>
            </div>`;
        return;
    }
    
    products.forEach(product => {
        if (!product) return;
        
        const sizeOptions = product.sizes && product.sizes.length > 0 
            ? product.sizes.map(size => `<option value="${size}">${size}</option>`).join("")
            : '<option value="">One Size</option>';
        
        const sizeTags = product.sizes && product.sizes.length > 0 
            ? `<div class="product-sizes">${product.sizes.map(size => `<span class="size-tag">${size}</span>`).join("")}</div>`
            : '';
        
        const isOutOfStock = product.stock === 0;
        const productImage = product.image || getDefaultImage();
        
        productGrid.innerHTML += `
        <div class="card">
            <div style="overflow: hidden; height: 250px;">
                <img src="${productImage}" alt="${product.name}" style="height: 100%; width: 100%;">
            </div>
            <div class="card-body">
                <h4 style="margin: 0 0 8px 0; font-size: 16px; line-height: 1.4;">${product.name}</h4>
                ${sizeTags}
                <div class="price">$${product.price ? product.price.toFixed(2) : '0.00'}</div>
                <div style="color: #666; margin: 8px 0;">Stock: <b>${product.stock || 0}</b></div>
                <select class="size-select" id="sizeSelect-${product.id}">
                    <option value="">Select Size</option>
                    ${sizeOptions}
                </select>
                <button class="btn btn-orange" onclick="addToCart(${product.id})" 
                    ${isOutOfStock ? 'disabled' : ''}
                    style="width: 100%;">
                    ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                </button>
                ${isOutOfStock ? '<div class="alert-stock">Out of Stock!</div>' : ''}
            </div>
        </div>`;
    });
    
    updateCartCount();
}

function getDefaultImage() {
    return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjgwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM5OTkiPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';
}

// Cart Functions
function addToCart(id) {
    const product = products.find(p => p.id === id);
    if (!product || product.stock <= 0) {
        alert("This product is out of stock!");
        return;
    }
    
    const selectedSize = document.getElementById(`sizeSelect-${id}`)?.value;
    if (!selectedSize || selectedSize === "") {
        alert("Please select a size first!");
        return;
    }
    
    const existingItem = cart.find(item => item.id === id && item.size === selectedSize);
    
    if (existingItem) {
        if (existingItem.qty >= product.stock) {
            alert("Not enough stock available!");
            return;
        }
        existingItem.qty++;
    } else {
        cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            size: selectedSize,
            qty: 1
        });
    }
    
    product.stock--;
    localStorage.setItem("products", JSON.stringify(products));
    localStorage.setItem("cart", JSON.stringify(cart));
    loadData();
    render();
}

function updateCartCount() {
    const totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
    cartCount.textContent = totalItems;
}

function openCart() {
    renderCart();
    cartModal.style.display = "flex";
}

function closeCart() {
    cartModal.style.display = "none";
}

function renderCart() {
    const cartItems = document.getElementById("cartItems");
    
    if (cart.length === 0) {
        cartItems.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 60px; margin-bottom: 20px;">üõí</div>
                <h3 style="color: #666; margin-bottom: 10px;">Your Cart is Empty</h3>
                <p style="color: #999;">Add some products to your cart!</p>
            </div>`;
        document.getElementById("cartTotal").textContent = "Total: $0.00";
        return;
    }
    
    let html = "";
    let total = 0;
    
    cart.forEach((item, index) => {
        const itemTotal = item.price * item.qty;
        total += itemTotal;
        
        html += `
        <div class="cart-item">
            <div style="flex: 1;">
                <strong>${item.name}</strong>
                <div style="color: #666; font-size: 14px; margin-top: 4px;">
                    Size: ${item.size} | Qty: ${item.qty}
                </div>
                <div style="color: #ff6b35; font-weight: bold; margin-top: 4px;">
                    $${item.price.toFixed(2)} each
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-weight: bold; font-size: 16px;">$${itemTotal.toFixed(2)}</div>
                <button onclick="removeFromCart(${index})" style="margin-top: 8px; color: #e74c3c; border: none; background: none; cursor: pointer; font-size: 20px; padding: 0 8px;">√ó</button>
            </div>
        </div>`;
    });
    
    cartItems.innerHTML = html;
    document.getElementById("cartTotal").innerHTML = `
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold;">
                <span>Total:</span>
                <span style="color: #ff6b35;">$${total.toFixed(2)}</span>
            </div>
        </div>`;
}

function removeFromCart(index) {
    const item = cart[index];
    const product = products.find(p => p.id === item.id);
    
    if (product) {
        product.stock += item.qty;
    }
    
    cart.splice(index, 1);
    localStorage.setItem("products", JSON.stringify(products));
    localStorage.setItem("cart", JSON.stringify(cart));
    loadData();
    render();
    renderCart();
}

function payViaPayWay() {
    window.open(PAYWAY_LINK, '_blank');
}

function sendOrder() {
    const name = document.getElementById("cname").value.trim();
    const phone = document.getElementById("cphone").value.trim();
    const address = document.getElementById("caddr").value.trim();
    
    if (!name || !phone || !address) {
        alert("Please fill in all customer information");
        return;
    }
    
    if (cart.length === 0) {
        alert("Your cart is empty");
        return;
    }
    
    let message = `üõí New Order%0A%0A`;
    message += `üë§ Customer: ${name}%0A`;
    message += `üìû Phone: ${phone}%0A`;
    message += `üìç Address: ${address}%0A%0A`;
    message += `üì¶ Order Details:%0A`;
    
    let total = 0;
    cart.forEach(item => {
        const itemTotal = item.price * item.qty;
        total += itemTotal;
        message += `‚Ä¢ ${item.name} (${item.size}) √ó ${item.qty} = $${itemTotal.toFixed(2)}%0A`;
    });
    
    message += `%0Aüí∞ Total: $${total.toFixed(2)}%0A`;
    message += `üí≥ Pay online: ${PAYWAY_LINK}`;
    
    orders.push({
        id: Date.now(),
        date: new Date().toLocaleString(),
        name: name,
        phone: phone,
        address: address,
        total: total,
        items: [...cart],
        status: 'pending'
    });
    
    localStorage.setItem("orders", JSON.stringify(orders));
    cart = [];
    localStorage.removeItem("cart");
    loadData();
    updateCartCount();
    window.open(`https://m.me/${PAGE_NAME}?text=${message}`, '_blank');
    closeCart();
    render();
    renderOrders();
}

// Order History - FIXED VERSION
function renderOrders() {
    const ordersDiv = document.getElementById("orders");
    if (orders.length === 0) {
        ordersDiv.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No orders yet.</p>';
        return;
    }
    ordersDiv.innerHTML = orders.map(order => `
        <div class="order">
            <strong>Order #${order.id}</strong><br>
            <small>${order.date}</small><br>
            ${order.name} (${order.phone})<br>
            ${order.address}<br>
            Total: <b style="color: #ff6b35;">$${order.total.toFixed(2)}</b><br>
            Status: <span style="color: ${(order.status || 'pending') === 'pending' ? '#e67e22' : '#27ae60'}; font-weight: bold;">
                ${(order.status || 'pending').toUpperCase()}
            </span>
        </div>
    `).join("");
}

// Admin Edit Products List with DELETE buttons
function renderEditProducts() {
    editProductsDiv.innerHTML = "";
    
    if (products.length === 0) {
        editProductsDiv.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No products to edit.</p>';
        return;
    }
    
    products.forEach(product => {
        editProductsDiv.innerHTML += `
        <div class="order">
            <div style="display: flex; align-items: center; gap: 15px;">
                <img src="${product.image || getDefaultImage()}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px;">
                <div style="flex: 1;">
                    <strong>${product.name}</strong><br>
                    Price: $${product.price.toFixed(2)} | Stock: ${product.stock}<br>
                    Sizes: ${product.sizes ? product.sizes.join(", ") : "N/A"}
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-blue" onclick="editProduct(${product.id})" style="padding: 8px 16px;">Edit</button>
                    <button class="btn btn-red" onclick="deleteProduct(${product.id})" style="padding: 8px 16px;">Delete</button>
                </div>
            </div>
        </div>`;
    });
}

// Initialization - FIXED VERSION FOR PUBLIC VIEW
function init() {
    console.log("=== PAGE LOAD INIT ===");
    
    // Load data from localStorage
    loadData();
    
    console.log("Loaded:", products.length, "products");
    console.log("User is admin:", isAdmin);
    console.log("Admin unlocked:", adminUnlocked);
    
    // Render products regardless of admin status
    render();
    updateCartCount();
    
    // Show admin button if previously unlocked
    if (adminUnlocked) {
        adminBtn.style.display = "inline-block";
        console.log("Admin button shown (unlocked)");
    }
    
    // CRITICAL: Always show store for public visitors
    // Only show admin panel if user is explicitly logged in as admin AND has unlocked admin
    if (isAdmin && adminUnlocked) {
        console.log("Admin is logged in and unlocked, showing admin panel...");
        showAdmin();
    } else {
        console.log("Showing public store view...");
        // Make sure store is visible for public users
        store.classList.remove("hidden");
        admin.classList.add("hidden");
        
        // Hide admin button for public users if not unlocked
        if (!adminUnlocked) {
            adminBtn.style.display = "none";
        }
    }
    
    console.log("=== INIT COMPLETE ===");
}

// Initialize the application
init();

// Extra safety: Force store view on page load for public users
window.addEventListener('DOMContentLoaded', function() {
    // If user is not admin, ensure store is visible
    if (!isAdmin) {
        store.classList.remove('hidden');
        admin.classList.add('hidden');
    }
});
</script>
</body>
</html>

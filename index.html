<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Goad Kids Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
* { box-sizing: border-box; font-family: Segoe UI, system-ui, sans-serif; margin: 0; padding: 0; }
body { background: #f5f6f8; min-height: 100vh; }
header { background: #fff; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,.1); position: sticky; top: 0; z-index: 100; }
.container { max-width: 1200px; margin: auto; padding: 15px; }
.flex { display: flex; justify-content: space-between; align-items: center; }
nav button { margin-left: 8px; border: none; background: #eee; padding: 8px 14px; border-radius: 6px; cursor: pointer; transition: all 0.3s; font-size: 14px; }
nav button:hover { background: #ddd; }
.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
.card { background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,.08); position: relative; transition: all 0.3s; }
.card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,.12); }
.card img { width: 100%; height: 220px; object-fit: cover; display: block; }
.card-body { padding: 15px; }
.price { color: #ff6b35; font-weight: bold; font-size: 1.2em; margin: 6px 0; }
.btn { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; margin-top: 8px; transition: all 0.3s; font-weight: 500; font-size: 14px; display: block; width: 100%; }
.btn:hover { opacity: 0.9; transform: translateY(-1px); }
.btn-orange { background: linear-gradient(135deg, #ff6b35, #ff8e53); color: #fff; }
.btn-blue { background: linear-gradient(135deg, #4a90e2, #6aa7f0); color: #fff; }
.btn-red { background: linear-gradient(135deg, #e74c3c, #ff6b5c); color: #fff; }
.btn-gray { background: linear-gradient(135deg, #95a5a6, #b4c0c1); color: #fff; }
.btn-green { background: linear-gradient(135deg, #27ae60, #2ecc71); color: #fff; }
.hidden { display: none !important; }
.modal { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 15px; display: none; }
.modal.active { display: flex !important; }
.modal-content { background: #fff; padding: 20px; border-radius: 12px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
input, textarea, select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; -webkit-appearance: none; }
input:focus, textarea:focus, select:focus { outline: none; border-color: #4a90e2; box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1); }
.cart-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 12px; border-bottom: 1px solid #eee; }
.preview { width: 100%; height: 180px; object-fit: contain; border-radius: 8px; margin-bottom: 12px; border: 1px solid #eee; background: #f8f9fa; }
.order { background: #fff; padding: 15px; margin-bottom: 12px; border-radius: 8px; border-left: 4px solid #4a90e2; }
.alert-stock { color: #e74c3c; font-weight: bold; margin-top: 8px; padding: 5px; background: #fee; border-radius: 4px; text-align: center; font-size: 13px; }
.edit-btn { background: #4a90e2; color: #fff; width: 100%; margin-top: 8px; }
.form-group { margin-bottom: 16px; }
.form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 14px; }
.alert { padding: 12px; border-radius: 6px; margin-bottom: 12px; font-size: 14px; }
.alert-error { background: linear-gradient(135deg, #fee, #fdd); color: #c33; border: 1px solid #fcc; }
.alert-success { background: linear-gradient(135deg, #efe, #dfd); color: #393; border: 1px solid #cfc; }
.password-section { background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; margin: 25px 0; border: 1px solid #dee2e6; }
.product-sizes { display: flex; gap: 6px; flex-wrap: wrap; margin: 10px 0; }
.size-tag { padding: 3px 10px; background: #f0f0f0; border-radius: 15px; font-size: 12px; }
.size-select { padding: 10px; border-radius: 6px; border: 1px solid #ddd; background: #fff; margin-top: 10px; font-size: 14px; }
.image-upload-container { border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 15px; background: #fafafa; }
.image-upload-container:hover { border-color: #4a90e2; }
.image-upload-label { display: block; cursor: pointer; color: #666; font-size: 14px; }
.image-upload-label:hover { color: #4a90e2; }
.image-upload-icon { font-size: 36px; margin-bottom: 10px; }
/* Secret admin access area */
.secret-admin-area { 
    position: fixed; 
    top: 0; 
    right: 0; 
    width: 80px; 
    height: 40px; 
    background: transparent; 
    z-index: 10000; 
    cursor: pointer; 
}
/* Mobile-specific styles */
@media (max-width: 768px) {
    .container { padding: 10px; }
    header { padding: 10px 15px; }
    nav button { 
        padding: 6px 10px; 
        margin-left: 5px; 
        font-size: 13px;
        min-height: 36px;
    }
    .grid { 
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
        gap: 12px;
    }
    .card img { height: 160px; }
    .card-body { padding: 10px; }
    .price { font-size: 1.1em; }
    .btn { padding: 8px 12px; font-size: 13px; }
    .modal-content { 
        padding: 15px; 
        margin: 10px;
        max-height: 85vh;
    }
    h2 { font-size: 1.3em; }
    h3 { font-size: 1.1em; }
    h4 { font-size: 1em; }
}

@media (max-width: 480px) {
    .grid { grid-template-columns: repeat(2, 1fr); }
    nav button { 
        padding: 5px 8px; 
        font-size: 12px;
        margin-left: 3px;
    }
    .modal-content { padding: 12px; }
    .card img { height: 140px; }
    input, textarea, select { 
        padding: 10px;
        font-size: 16px; /* Prevent iOS zoom */
    }
}

/* Fix for very small screens */
@media (max-width: 360px) {
    .grid { grid-template-columns: 1fr; }
    nav button span { display: none; }
    nav button:after { content: "üõí"; }
    #cartCount { display: inline; }
}

/* Prevent text size adjustment on iOS */
html { -webkit-text-size-adjust: 100%; }
/* Fix tap highlight color */
* { -webkit-tap-highlight-color: transparent; }
/* Improve scrolling on iOS */
body { -webkit-overflow-scrolling: touch; }
</style>
</head>
<body>

<!-- Secret admin unlock area (invisible in top-right corner) -->
<div class="secret-admin-area" onclick="unlockAdmin()" title="Click to unlock admin"></div>

<header>
<div class="container flex">
<b>üõí Goad Kids Store</b>
<nav>
<button onclick="openCart()">Cart (<span id="cartCount">0</span>)</button>
<button id="adminBtn" onclick="openAdmin()" style="display: none;">Admin</button>
<button onclick="forceRefresh()" style="background: #ff6b35; color: white;">Refresh</button>
</nav>
</div>
</header>

<div class="container">

<!-- STORE -->
<section id="store">
<div class="grid" id="productGrid">
<!-- Products will be loaded here -->
</div>
</section>

<!-- ADMIN -->
<section id="admin" class="hidden">
<h2>Admin Panel</h2>
<div class="form-group">
<label for="name">Product Name</label>
<input id="name" placeholder="Enter product name">
</div>
<div class="form-group">
<label for="price">Price ($)</label>
<input id="price" type="number" min="0" step="0.01" placeholder="0.00">
</div>
<div class="form-group">
<label for="stock">Stock Quantity</label>
<input id="stock" type="number" min="0" placeholder="0">
</div>
<div class="form-group">
<label for="size">Sizes (comma separated)</label>
<input id="size" placeholder="S, M, L, XL">
</div>
<div class="form-group">
<label>Product Image</label>
<div class="image-upload-container">
<div class="image-upload-label" onclick="document.getElementById('image').click()">
<div class="image-upload-icon">üì∑</div>
Click to upload image
<br><small>Max 5MB</small>
</div>
<input type="file" id="image" accept="image/*" style="display: none;">
<div id="imageError" class="alert alert-error hidden"></div>
</div>
</div>
<img id="preview" class="preview hidden">
<div class="flex" style="gap: 10px;">
<button id="saveProductBtn" class="btn btn-orange" onclick="saveProduct()">Add Product</button>
<button id="cancelEditBtn" class="btn btn-gray hidden" onclick="cancelEdit()">Cancel Edit</button>
</div>

<!-- PASSWORD CHANGE SECTION -->
<div class="password-section">
<h3>Change Admin Password</h3>
<div id="passwordMessage" class="alert hidden"></div>
<div class="form-group">
<label for="oldPass">Old Password</label>
<input type="password" id="oldPass" placeholder="Enter old password">
</div>
<div class="form-group">
<label for="newPass">New Password</label>
<input type="password" id="newPass" placeholder="Enter new password (min 4 chars)">
</div>
<div class="form-group">
<label for="confirmPass">Confirm New Password</label>
<input type="password" id="confirmPass" placeholder="Confirm new password">
</div>
<button class="btn btn-green" onclick="changePassword()">Change Password</button>
</div>

<h3>Order History</h3>
<div id="orders"></div>

<h3>Edit Products</h3>
<div id="editProducts"></div>

<div style="display: flex; gap: 10px; margin-top: 20px;">
<button class="btn btn-blue" onclick="showStore()">View Store</button>
<button class="btn btn-red" onclick="logout()">Logout</button>
</div>
</section>

</div>

<!-- LOGIN MODAL -->
<div class="modal" id="loginModal">
<div class="modal-content">
<h3>Admin Login</h3>
<div class="form-group">
<label for="user">Username</label>
<input id="user" value="admin">
</div>
<div class="form-group">
<label for="pass">Password</label>
<input id="pass" type="password" placeholder="Enter password">
</div>
<div style="display: flex; gap: 10px;">
<button class="btn btn-blue" onclick="login()">Login</button>
<button class="btn btn-gray" onclick="closeModal('loginModal')">Cancel</button>
</div>
</div>
</div>

<!-- CART MODAL -->
<div class="modal" id="cartModal">
<div class="modal-content">
<h3>Your Cart</h3>
<div id="cartItems"></div>
<h4 id="cartTotal"></h4>

<h4>Customer Information</h4>
<div class="form-group">
<label for="cname">Full Name</label>
<input id="cname" placeholder="Enter your full name">
</div>
<div class="form-group">
<label for="cphone">Phone Number</label>
<input id="cphone" placeholder="Enter phone number" type="tel">
</div>
<div class="form-group">
<label for="caddr">Delivery Address</label>
<textarea id="caddr" placeholder="Enter delivery address" rows="3"></textarea>
</div>

<div class="form-group">
<p><b>Payment Method:</b></p>
<p>üí≥ Pay online via <a id="payText" href="#" target="_blank">PayWay</a></p>
</div>

<div style="display: flex; gap: 10px; flex-wrap: wrap;">
<button class="btn btn-orange" onclick="payViaPayWay()">Pay via PayWay</button>
<button class="btn btn-blue" onclick="sendOrder()">Order via Messenger</button>
<button class="btn btn-red" onclick="closeCart()">Close</button>
</div>
</div>
</div>

<script>
// ====================
// GLOBAL VARIABLES
// ====================
const productGrid = document.getElementById("productGrid");
const cartCount = document.getElementById("cartCount");
const store = document.getElementById("store");
const admin = document.getElementById("admin");
const loginModal = document.getElementById("loginModal");
const cartModal = document.getElementById("cartModal");
const editProductsDiv = document.getElementById("editProducts");
const imageInput = document.getElementById("image");
const preview = document.getElementById("preview");
const imageError = document.getElementById("imageError");
const saveProductBtn = document.getElementById("saveProductBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const passwordMessage = document.getElementById("passwordMessage");
const adminBtn = document.getElementById("adminBtn");

const PAYWAY_LINK = "https://link.payway.com.kh/08407860s";
const PAGE_NAME = "Goatkids";
const SECRET_UNLOCK_PASSWORD = "admin123";

// Initialize global data
let products = [];
let cart = [];
let orders = [];
let isAdmin = false;
let adminUnlocked = false;
let currentEditId = null;
let currentImageData = null;

// ====================
// MOBILE DETECTION & SETUP
// ====================
function isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

function setupMobileFeatures() {
    if (isMobile()) {
        console.log("Mobile device detected");
        
        // Improve touch scrolling
        document.body.style.overflow = 'auto';
        document.body.style.webkitOverflowScrolling = 'touch';
        
        // Add touch event listeners for better UX
        document.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('touchstart', function() {
                this.style.opacity = '0.7';
            });
            btn.addEventListener('touchend', function() {
                this.style.opacity = '1';
            });
        });
    }
}

// ====================
// LOCALSTORAGE FUNCTIONS (MOBILE SAFE)
// ====================
function loadData() {
    try {
        // Check if localStorage is available
        if (typeof localStorage === 'undefined') {
            console.error("localStorage not available");
            alert("Local storage not supported. Data will not be saved.");
            return;
        }
        
        // Load products
        const productsData = localStorage.getItem("products");
        if (productsData) {
            products = JSON.parse(productsData);
            if (!Array.isArray(products)) {
                products = [];
            }
        } else {
            products = [];
        }
        
        // Load cart
        const cartData = localStorage.getItem("cart");
        if (cartData) {
            cart = JSON.parse(cartData);
            if (!Array.isArray(cart)) cart = [];
        } else {
            cart = [];
        }
        
        // Load orders
        const ordersData = localStorage.getItem("orders");
        if (ordersData) {
            orders = JSON.parse(ordersData);
            if (!Array.isArray(orders)) orders = [];
        } else {
            orders = [];
        }
        
        // Load admin states
        isAdmin = localStorage.getItem("admin") === "true";
        adminUnlocked = localStorage.getItem("adminUnlocked") === "true";
        
        console.log("Data loaded:", products.length, "products");
        
    } catch (error) {
        console.error("Error loading data:", error);
        // Initialize empty data
        products = products || [];
        cart = cart || [];
        orders = orders || [];
    }
}

function saveData() {
    try {
        localStorage.setItem("products", JSON.stringify(products));
        localStorage.setItem("cart", JSON.stringify(cart));
        localStorage.setItem("orders", JSON.stringify(orders));
    } catch (error) {
        console.error("Error saving data:", error);
    }
}

// Initialize admin credentials if not set
if (!localStorage.getItem("adminPassword")) {
    localStorage.setItem("adminPassword", "admin123");
}

// ====================
// VIEW MANAGEMENT
// ====================

function showStore() {
    loadData();
    
    // Hide admin, show store
    admin.classList.add("hidden");
    store.classList.remove("hidden");
    
    // Re-render products
    render();
    
    console.log("Store view shown");
}

function showAdmin() {
    // Only show admin if properly authenticated AND unlocked
    if (!isAdmin || !adminUnlocked) {
        openAdmin();
        return;
    }
    
    // Hide store, show admin
    store.classList.add("hidden");
    admin.classList.remove("hidden");
    
    // Load admin data
    renderOrders();
    renderEditProducts();
    
    console.log("Admin panel shown");
}

function openAdmin() {
    if (!adminUnlocked) {
        unlockAdmin();
        return;
    }
    
    if (!isAdmin) {
        showModal('loginModal');
        return;
    }
    
    showAdmin();
}

// Secret Admin Unlock Function
function unlockAdmin() {
    const password = prompt("Enter admin unlock password:");
    
    if (password === SECRET_UNLOCK_PASSWORD) {
        adminUnlocked = true;
        localStorage.setItem("adminUnlocked", "true");
        adminBtn.style.display = "inline-block";
        alert("‚úì Admin access unlocked!");
    } else if (password) {
        alert("‚úó Incorrect password!");
    }
}

// ====================
// MODAL FUNCTIONS
// ====================

function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }
}

function openCart() {
    renderCart();
    showModal('cartModal');
}

function closeCart() {
    closeModal('cartModal');
}

// Close modals when clicking outside
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
        closeModal(e.target.id);
    }
});

// ====================
// IMAGE HANDLING
// ====================

imageInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    imageError.classList.add("hidden");
    
    if (!file.type.startsWith('image/')) {
        showImageError("Please select an image file");
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        showImageError("Image too large! Maximum size is 5MB");
        return;
    }
    
    const reader = new FileReader();
    reader.onload = async () => {
        const img = new Image();
        img.onload = async () => {
            preview.src = reader.result;
            preview.classList.remove("hidden");
            currentImageData = await resizeImage(reader.result, 600, 600);
        };
        img.src = reader.result;
    };
    reader.readAsDataURL(file);
};

function showImageError(message) {
    imageError.textContent = message;
    imageError.classList.remove("hidden");
    imageInput.value = "";
    preview.classList.add("hidden");
    currentImageData = null;
}

async function resizeImage(base64, maxWidth = 600, maxHeight = 600) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
                height = Math.round(height * maxWidth / width);
                width = maxWidth;
            }
            
            if (height > maxHeight) {
                width = Math.round(width * maxHeight / height);
                height = maxHeight;
            }
            
            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);
            
            resolve(canvas.toDataURL("image/jpeg", 0.8));
        };
        img.src = base64;
    });
}

// ====================
// AUTHENTICATION
// ====================

function login() {
    const user = document.getElementById("user").value;
    const pass = document.getElementById("pass").value;
    const storedPassword = localStorage.getItem("adminPassword");
    
    if (user === "admin" && pass === storedPassword) {
        isAdmin = true;
        localStorage.setItem("admin", "true");
        closeModal('loginModal');
        showAdmin();
    } else {
        alert("Invalid username or password");
    }
}

function logout() {
    isAdmin = false;
    localStorage.removeItem("admin");
    showStore();
    resetForm();
}

function changePassword() {
    const oldPass = document.getElementById("oldPass").value;
    const newPass = document.getElementById("newPass").value;
    const confirmPass = document.getElementById("confirmPass").value;
    const storedPassword = localStorage.getItem("adminPassword");
    
    passwordMessage.classList.add("hidden");
    
    if (!oldPass || !newPass || !confirmPass) {
        showPasswordMessage("Please fill in all fields", "error");
        return;
    }
    
    if (oldPass !== storedPassword) {
        showPasswordMessage("Old password is incorrect", "error");
        return;
    }
    
    if (newPass !== confirmPass) {
        showPasswordMessage("New passwords don't match", "error");
        return;
    }
    
    if (newPass.length < 4) {
        showPasswordMessage("New password must be at least 4 characters long", "error");
        return;
    }
    
    localStorage.setItem("adminPassword", newPass);
    
    document.getElementById("oldPass").value = "";
    document.getElementById("newPass").value = "";
    document.getElementById("confirmPass").value = "";
    
    showPasswordMessage("Password changed successfully!", "success");
}

function showPasswordMessage(message, type) {
    passwordMessage.textContent = message;
    passwordMessage.className = "alert";
    passwordMessage.classList.remove("hidden");
    
    if (type === "success") {
        passwordMessage.classList.add("alert-success");
    } else {
        passwordMessage.classList.add("alert-error");
    }
    
    if (type === "success") {
        setTimeout(() => {
            passwordMessage.classList.add("hidden");
        }, 3000);
    }
}

// ====================
// PRODUCT MANAGEMENT
// ====================

async function saveProduct() {
    const name = document.getElementById("name").value.trim();
    const price = parseFloat(document.getElementById("price").value);
    const stock = parseInt(document.getElementById("stock").value);
    const size = document.getElementById("size").value;
    
    if (!name) {
        alert("Product name is required");
        return;
    }
    
    if (isNaN(price) || price < 0) {
        alert("Please enter a valid price");
        return;
    }
    
    if (isNaN(stock) || stock < 0) {
        alert("Please enter a valid stock quantity");
        return;
    }
    
    if (currentEditId === null && !currentImageData) {
        alert("Please select an image for the new product");
        return;
    }
    
    const sizeValues = size.split(",").map(s => s.trim()).filter(s => s);
    
    if (currentEditId !== null) {
        const product = products.find(p => p.id === currentEditId);
        if (product) {
            product.name = name;
            product.price = price;
            product.stock = stock;
            product.sizes = sizeValues;
            if (currentImageData) product.image = currentImageData;
        }
    } else {
        const newProduct = {
            id: Date.now(),
            name: name,
            price: price,
            stock: stock,
            sizes: sizeValues,
            image: currentImageData
        };
        products.push(newProduct);
    }
    
    saveData();
    loadData();
    resetForm();
    renderEditProducts();
    
    const message = currentEditId !== null 
        ? "Product updated successfully!" 
        : "Product added successfully!";
    alert(message);
}

function deleteProduct(id) {
    if (!confirm("Are you sure you want to delete this product?")) {
        return;
    }
    
    // Remove from cart if present
    cart = cart.filter(item => item.id !== id);
    
    // Remove from products
    products = products.filter(p => p.id !== id);
    
    saveData();
    loadData();
    renderEditProducts();
    
    if (currentEditId === id) {
        resetForm();
    }
    
    alert("Product deleted successfully!");
}

function editProduct(id) {
    const product = products.find(p => p.id === id);
    if (!product) return;
    
    document.getElementById("name").value = product.name;
    document.getElementById("price").value = product.price;
    document.getElementById("stock").value = product.stock;
    document.getElementById("size").value = product.sizes.join(", ");
    
    if (product.image) {
        preview.src = product.image;
        preview.classList.remove("hidden");
        currentImageData = product.image;
    }
    
    currentEditId = id;
    saveProductBtn.textContent = "Update Product";
    saveProductBtn.className = "btn btn-blue";
    cancelEditBtn.classList.remove("hidden");
}

function resetForm() {
    document.getElementById("name").value = "";
    document.getElementById("price").value = "";
    document.getElementById("stock").value = "";
    document.getElementById("size").value = "";
    imageInput.value = "";
    preview.src = "";
    preview.classList.add("hidden");
    imageError.classList.add("hidden");
    currentEditId = null;
    currentImageData = null;
    saveProductBtn.textContent = "Add Product";
    saveProductBtn.className = "btn btn-orange";
    cancelEditBtn.classList.add("hidden");
}

function cancelEdit() {
    resetForm();
}

// ====================
// RENDER FUNCTIONS (MOBILE OPTIMIZED)
// ====================

function render() {
    console.log("Rendering products for mobile:", isMobile());
    
    if (!productGrid) {
        console.error("productGrid element not found!");
        return;
    }
    
    productGrid.innerHTML = "";
    
    // Validate products array
    if (!Array.isArray(products)) {
        products = [];
    }
    
    const validProducts = products.filter(p => p && p.id && p.name);
    
    if (validProducts.length === 0) {
        productGrid.innerHTML = `
            <div style="text-align: center; grid-column: 1/-1; padding: 40px 20px;">
                <div style="font-size: 40px; margin-bottom: 15px;">üõçÔ∏è</div>
                <h3 style="color: #666; margin-bottom: 10px;">No Products Available</h3>
                <p style="color: #999;">Add products in admin panel</p>
            </div>`;
        return;
    }
    
    validProducts.forEach(product => {
        const sizeOptions = product.sizes && product.sizes.length > 0 
            ? product.sizes.map(size => `<option value="${size}">${size}</option>`).join("")
            : '<option value="">One Size</option>';
        
        const sizeTags = product.sizes && product.sizes.length > 0 
            ? `<div class="product-sizes">${product.sizes.map(size => `<span class="size-tag">${size}</span>`).join("")}</div>`
            : '';
        
        const isOutOfStock = product.stock === 0;
        const productImage = product.image || getDefaultImage();
        
        const cardHTML = `
        <div class="card">
            <div>
                <img src="${productImage}" alt="${product.name}" loading="lazy">
            </div>
            <div class="card-body">
                <h4 style="margin: 0 0 6px 0; font-size: 15px; line-height: 1.3;">${product.name}</h4>
                ${sizeTags}
                <div class="price">$${product.price ? product.price.toFixed(2) : '0.00'}</div>
                <div style="color: #666; margin: 6px 0; font-size: 13px;">Stock: <b>${product.stock || 0}</b></div>
                <select class="size-select" id="sizeSelect-${product.id}">
                    <option value="">Select Size</option>
                    ${sizeOptions}
                </select>
                <button class="btn btn-orange" onclick="addToCart(${product.id})" 
                    ${isOutOfStock ? 'disabled' : ''}>
                    ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                </button>
                ${isOutOfStock ? '<div class="alert-stock">Out of Stock!</div>' : ''}
            </div>
        </div>`;
        
        productGrid.innerHTML += cardHTML;
    });
    
    updateCartCount();
}

function getDefaultImage() {
    return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjYwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjAiIGZpbGw9IiM5OTkiPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';
}

function renderCart() {
    const cartItems = document.getElementById("cartItems");
    
    if (cart.length === 0) {
        cartItems.innerHTML = `
            <div style="text-align: center; padding: 30px 15px;">
                <div style="font-size: 40px; margin-bottom: 15px;">üõí</div>
                <h3 style="color: #666; margin-bottom: 10px;">Your Cart is Empty</h3>
                <p style="color: #999;">Add some products to your cart!</p>
            </div>`;
        document.getElementById("cartTotal").textContent = "Total: $0.00";
        return;
    }
    
    let html = "";
    let total = 0;
    
    cart.forEach((item, index) => {
        const itemTotal = item.price * item.qty;
        total += itemTotal;
        
        html += `
        <div class="cart-item">
            <div style="flex: 1;">
                <strong>${item.name}</strong>
                <div style="color: #666; font-size: 13px; margin-top: 4px;">
                    Size: ${item.size} | Qty: ${item.qty}
                </div>
                <div style="color: #ff6b35; font-weight: bold; margin-top: 4px; font-size: 14px;">
                    $${item.price.toFixed(2)} each
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-weight: bold; font-size: 15px;">$${itemTotal.toFixed(2)}</div>
                <button onclick="removeFromCart(${index})" style="margin-top: 8px; color: #e74c3c; border: none; background: none; cursor: pointer; font-size: 20px; padding: 0 8px;">√ó</button>
            </div>
        </div>`;
    });
    
    cartItems.innerHTML = html;
    document.getElementById("cartTotal").innerHTML = `
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <div style="display: flex; justify-content: space-between; font-size: 17px; font-weight: bold;">
                <span>Total:</span>
                <span style="color: #ff6b35;">$${total.toFixed(2)}</span>
            </div>
        </div>`;
}

function renderOrders() {
    const ordersDiv = document.getElementById("orders");
    if (orders.length === 0) {
        ordersDiv.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No orders yet.</p>';
        return;
    }
    ordersDiv.innerHTML = orders.map(order => `
        <div class="order">
            <strong>Order #${order.id}</strong><br>
            <small>${order.date}</small><br>
            ${order.name} (${order.phone})<br>
            ${order.address}<br>
            Total: <b style="color: #ff6b35;">$${order.total.toFixed(2)}</b><br>
            Status: <span style="color: ${(order.status || 'pending') === 'pending' ? '#e67e22' : '#27ae60'}; font-weight: bold;">
                ${(order.status || 'pending').toUpperCase()}
            </span>
        </div>
    `).join("");
}

function renderEditProducts() {
    editProductsDiv.innerHTML = "";
    
    if (products.length === 0) {
        editProductsDiv.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No products to edit.</p>';
        return;
    }
    
    products.forEach(product => {
        editProductsDiv.innerHTML += `
        <div class="order">
            <div style="display: flex; align-items: center; gap: 12px;">
                <img src="${product.image || getDefaultImage()}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;">
                <div style="flex: 1;">
                    <strong>${product.name}</strong><br>
                    Price: $${product.price.toFixed(2)} | Stock: ${product.stock}<br>
                    Sizes: ${product.sizes ? product.sizes.join(", ") : "N/A"}
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-blue" onclick="editProduct(${product.id})" style="padding: 6px 12px; font-size: 13px;">Edit</button>
                    <button class="btn btn-red" onclick="deleteProduct(${product.id})" style="padding: 6px 12px; font-size: 13px;">Delete</button>
                </div>
            </div>
        </div>`;
    });
}

// ====================
// CART FUNCTIONS
// ====================

function addToCart(id) {
    const product = products.find(p => p.id === id);
    if (!product || product.stock <= 0) {
        alert("This product is out of stock!");
        return;
    }
    
    const selectElement = document.getElementById(`sizeSelect-${id}`);
    if (!selectElement) {
        alert("Size selection not found!");
        return;
    }
    
    const selectedSize = selectElement.value;
    if (!selectedSize || selectedSize === "") {
        alert("Please select a size first!");
        return;
    }
    
    const existingItem = cart.find(item => item.id === id && item.size === selectedSize);
    
    if (existingItem) {
        if (existingItem.qty >= product.stock) {
            alert("Not enough stock available!");
            return;
        }
        existingItem.qty++;
    } else {
        cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            size: selectedSize,
            qty: 1
        });
    }
    
    product.stock--;
    saveData();
    loadData();
    render();
    
    // Show success feedback
    const btn = selectElement.nextElementSibling;
    const originalText = btn.innerHTML;
    btn.innerHTML = "‚úì Added!";
    btn.style.background = "#27ae60";
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.style.background = "";
    }, 1000);
}

function updateCartCount() {
    const totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
    if (cartCount) {
        cartCount.textContent = totalItems;
    }
}

function removeFromCart(index) {
    const item = cart[index];
    const product = products.find(p => p.id === item.id);
    
    if (product) {
        product.stock += item.qty;
    }
    
    cart.splice(index, 1);
    saveData();
    loadData();
    render();
    renderCart();
}

// ====================
// ORDER FUNCTIONS
// ====================

function payViaPayWay() {
    window.open(PAYWAY_LINK, '_blank');
}

function sendOrder() {
    const name = document.getElementById("cname").value.trim();
    const phone = document.getElementById("cphone").value.trim();
    const address = document.getElementById("caddr").value.trim();
    
    if (!name || !phone || !address) {
        alert("Please fill in all customer information");
        return;
    }
    
    if (cart.length === 0) {
        alert("Your cart is empty");
        return;
    }
    
    let message = `üõí New Order%0A%0A`;
    message += `üë§ Customer: ${name}%0A`;
    message += `üìû Phone: ${phone}%0A`;
    message += `üìç Address: ${address}%0A%0A`;
    message += `üì¶ Order Details:%0A`;
    
    let total = 0;
    cart.forEach(item => {
        const itemTotal = item.price * item.qty;
        total += itemTotal;
        message += `‚Ä¢ ${item.name} (${item.size}) √ó ${item.qty} = $${itemTotal.toFixed(2)}%0A`;
    });
    
    message += `%0Aüí∞ Total: $${total.toFixed(2)}%0A`;
    message += `üí≥ Pay online: ${PAYWAY_LINK}`;
    
    orders.push({
        id: Date.now(),
        date: new Date().toLocaleString(),
        name: name,
        phone: phone,
        address: address,
        total: total,
        items: [...cart],
        status: 'pending'
    });
    
    saveData();
    cart = [];
    localStorage.removeItem("cart");
    loadData();
    updateCartCount();
    
    // Open messenger
    const messengerUrl = `https://m.me/${PAGE_NAME}?text=${message}`;
    window.open(messengerUrl, '_blank');
    
    closeCart();
    render();
    renderOrders();
    
    alert("Order submitted successfully!");
}

// ====================
// UTILITY FUNCTIONS
// ====================

function forceRefresh() {
    loadData();
    render();
    updateCartCount();
    
    alert(`Refreshed!\n‚Ä¢ Products: ${products.length}\n‚Ä¢ Cart: ${cart.length} items\n‚Ä¢ Orders: ${orders.length}`);
}

// ====================
// INITIALIZATION (MOBILE SAFE)
// ====================

function init() {
    console.log("Initializing store on mobile:", isMobile());
    
    // Setup mobile features
    setupMobileFeatures();
    
    // Initialize PayWay link
    const payText = document.getElementById("payText");
    if (payText) {
        payText.textContent = "PayWay";
        payText.href = PAYWAY_LINK;
    }
    
    // Load all data
    loadData();
    
    // Render products
    render();
    
    // Show/hide admin button
    if (adminBtn) {
        adminBtn.style.display = adminUnlocked ? "inline-block" : "none";
    }
    
    // Determine which view to show
    if (isAdmin && adminUnlocked) {
        console.log("Showing admin panel");
        showAdmin();
    } else {
        console.log("Showing store");
        showStore();
    }
    
    console.log("Store initialized successfully");
}

// Initialize when everything is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM loaded, initializing...");
        setTimeout(init, 100);
    });
} else {
    console.log("DOM already loaded, initializing now...");
    setTimeout(init, 100);
}

// Handle page visibility changes
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        console.log("Page became visible, refreshing...");
        loadData();
        if (!admin.classList.contains('hidden')) {
            renderOrders();
            renderEditProducts();
        } else {
            render();
        }
    }
});

// Handle orientation change on mobile
window.addEventListener('orientationchange', function() {
    setTimeout(function() {
        render();
    }, 300);
});
</script>
</body>
</html>

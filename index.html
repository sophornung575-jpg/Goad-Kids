<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* { box-sizing: border-box; font-family: Segoe UI, system-ui, sans-serif; }
body { margin: 0; background: #f5f6f8; }
header { background: #fff; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,.1); }
.container { max-width: 1200px; margin: auto; padding: 20px; }
.flex { display: flex; justify-content: space-between; align-items: center; }
nav button { margin-left: 10px; border: none; background: #eee; padding: 8px 14px; border-radius: 6px; cursor: pointer; transition: background 0.3s; }
nav button:hover { background: #ddd; }
.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; margin-top: 20px; }
.card { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 6px 15px rgba(0,0,0,.1); position: relative; transition: transform 0.3s, box-shadow 0.3s; }
.card:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0,0,0,.15); }
.card img { width: 100%; height: 250px; object-fit: cover; transition: transform 0.3s; }
.card:hover img { transform: scale(1.05); }
.card-body { padding: 15px; }
.price { color: #ff6b35; font-weight: bold; font-size: 1.3em; margin: 8px 0; }
.btn { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; margin-top: 8px; transition: all 0.3s; font-weight: 500; }
.btn:hover { opacity: 0.9; transform: translateY(-2px); }
.btn-orange { background: linear-gradient(135deg, #ff6b35, #ff8e53); color: #fff; }
.btn-blue { background: linear-gradient(135deg, #4a90e2, #6aa7f0); color: #fff; }
.btn-red { background: linear-gradient(135deg, #e74c3c, #ff6b5c); color: #fff; }
.btn-gray { background: linear-gradient(135deg, #95a5a6, #b4c0c1); color: #fff; }
.btn-green { background: linear-gradient(135deg, #27ae60, #2ecc71); color: #fff; }
.hidden { display: none !important; }
.modal { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
input, textarea, select { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
input:focus, textarea:focus, select:focus { outline: none; border-color: #4a90e2; box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1); }
.cart-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 12px; border-bottom: 1px solid #eee; }
.preview { width: 100%; height: 200px; object-fit: contain; border-radius: 8px; margin-bottom: 12px; border: 1px solid #eee; background: #f8f9fa; }
.order { background: #fff; padding: 15px; margin-bottom: 12px; border-radius: 8px; border-left: 4px solid #4a90e2; }
.alert-stock { color: #e74c3c; font-weight: bold; margin-top: 8px; padding: 5px; background: #fee; border-radius: 4px; text-align: center; }
.edit-btn { background: #4a90e2; color: #fff; width: 100%; margin-top: 8px; }
.form-group { margin-bottom: 18px; }
.form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #333; }
.alert { padding: 12px; border-radius: 6px; margin-bottom: 12px; }
.alert-error { background: linear-gradient(135deg, #fee, #fdd); color: #c33; border: 1px solid #fcc; }
.alert-success { background: linear-gradient(135deg, #efe, #dfd); color: #393; border: 1px solid #cfc; }
.password-section { background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; margin: 25px 0; border: 1px solid #dee2e6; }
.product-sizes { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0; }
.size-tag { padding: 4px 12px; background: #f0f0f0; border-radius: 20px; font-size: 13px; }
.size-select { padding: 8px; border-radius: 6px; border: 1px solid #ddd; background: #fff; margin-top: 10px; }
.image-upload-container { border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 15px; background: #fafafa; }
.image-upload-container:hover { border-color: #4a90e2; }
.image-upload-label { display: block; cursor: pointer; color: #666; }
.image-upload-label:hover { color: #4a90e2; }
.image-upload-icon { font-size: 40px; margin-bottom: 10px; }
/* Secret admin access area - invisible */
.secret-admin-area { position: fixed; top: 0; right: 0; width: 100px; height: 40px; background: transparent; z-index: 10000; cursor: pointer; }
</style>
</head>
<body>

<div class="secret-admin-area" onclick="unlockAdmin()" title="Click to unlock admin"></div>

<header>
<div class="container flex">
<b>ðŸ›’ My Store</b>
<nav>
<button onclick="openCart()">Cart (<span id="cartCount">0</span>)</button>
<button id="adminBtn" onclick="openAdmin()" style="display: none;">Admin</button>
</nav>
</div>
</header>

<div class="container">
<section id="store">
<div class="grid" id="productGrid"></div>
</section>

<section id="admin" class="hidden">
<h2>Admin Panel</h2>
<div class="form-group">
<label for="name">Product Name</label>
<input id="name" placeholder="Enter product name">
</div>
<div class="form-group">
<label for="price">Price ($)</label>
<input id="price" type="number" min="0" step="0.01" placeholder="0.00">
</div>
<div class="form-group">
<label for="stock">Stock Quantity</label>
<input id="stock" type="number" min="0" placeholder="0">
</div>
<div class="form-group">
<label for="size">Sizes (comma separated)</label>
<input id="size" placeholder="S, M, L, XL">
</div>
<div class="form-group">
<label>Product Image</label>
<div class="image-upload-container">
<div class="image-upload-label" onclick="document.getElementById('image').click()">
<div class="image-upload-icon">ðŸ“·</div>
Click to upload image or drag & drop
<br><small>Recommended: 800x800px, max 5MB</small>
</div>
<input type="file" id="image" accept="image/*" style="display: none;">
<div id="imageError" class="alert alert-error hidden"></div>
</div>
</div>
<img id="preview" class="preview hidden">
<div class="flex">
<button id="saveProductBtn" class="btn btn-orange" onclick="saveProduct()">Add Product</button>
<button id="cancelEditBtn" class="btn btn-gray hidden" onclick="cancelEdit()" style="margin-left: 10px;">Cancel Edit</button>
</div>

<div class="password-section">
<h3>Change Admin Password</h3>
<div id="passwordMessage" class="alert hidden"></div>
<div class="form-group">
<label for="oldPass">Old Password</label>
<input type="password" id="oldPass" placeholder="Enter old password">
</div>
<div class="form-group">
<label for="newPass">New Password</label>
<input type="password" id="newPass" placeholder="Enter new password (min 4 chars)">
</div>
<div class="form-group">
<label for="confirmPass">Confirm New Password</label>
<input type="password" id="confirmPass" placeholder="Confirm new password">
</div>
<button class="btn btn-green" onclick="changePassword()">Change Password</button>
</div>

<h3>Order History</h3>
<div id="orders"></div>

<h3>Edit Products</h3>
<div id="editProducts"></div>

<button class="btn btn-red" onclick="logout()" style="margin-top: 20px;">Logout</button>
</section>
</div>

<!-- LOGIN MODAL -->
<div class="modal" id="loginModal">
<div class="modal-content">
<h3>Admin Login</h3>
<div class="form-group">
<label for="user">Username</label>
<input id="user" value="admin">
</div>
<div class="form-group">
<label for="pass">Password</label>
<input id="pass" type="password" placeholder="Enter password">
</div>
<button class="btn btn-blue" onclick="login()">Login</button>
</div>
</div>

<!-- CART MODAL -->
<div class="modal" id="cartModal">
<div class="modal-content">
<h3>Your Cart</h3>
<div id="cartItems"></div>
<h4 id="cartTotal"></h4>

<h4>Customer Information</h4>
<div class="form-group">
<label for="cname">Full Name</label>
<input id="cname" placeholder="Enter your full name">
</div>
<div class="form-group">
<label for="cphone">Phone Number</label>
<input id="cphone" placeholder="Enter phone number">
</div>
<div class="form-group">
<label for="caddr">Delivery Address</label>
<textarea id="caddr" placeholder="Enter delivery address" rows="3"></textarea>
</div>

<div class="form-group">
<p><b>Payment Method:</b></p>
<p>ðŸ’³ Pay online via <a id="payText" href="#" target="_blank">PayWay</a></p>
</div>

<div class="flex">
<button class="btn btn-orange" onclick="payViaPayWay()">ðŸ’³ Pay via PayWay</button>
<button class="btn btn-blue" onclick="sendOrder()">ðŸ“© Order via Messenger</button>
<button class="btn btn-red" onclick="closeCart()">Close</button>
</div>
</div>
</div>

<script>
// === GLOBAL VARIABLES ===
const productGrid = document.getElementById("productGrid");
const cartCount = document.getElementById("cartCount");
const store = document.getElementById("store");
const admin = document.getElementById("admin");
const loginModal = document.getElementById("loginModal");
const cartModal = document.getElementById("cartModal");
const editProductsDiv = document.getElementById("editProducts");
const imageInput = document.getElementById("image");
const preview = document.getElementById("preview");
const imageError = document.getElementById("imageError");
const saveProductBtn = document.getElementById("saveProductBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const passwordMessage = document.getElementById("passwordMessage");
const adminBtn = document.getElementById("adminBtn");

const PAYWAY_LINK = "https://link.payway.com.kh/08407860s";
const PAGE_NAME = "Goatkids";
const SECRET_UNLOCK_PASSWORD = "admin123";

// LocalStorage Data
let products = JSON.parse(localStorage.getItem("products")) || [];
let cart = JSON.parse(localStorage.getItem("cart")) || [];
let orders = JSON.parse(localStorage.getItem("orders")) || [];
let isAdmin = localStorage.getItem("admin") === "true";
let adminUnlocked = localStorage.getItem("adminUnlocked") === "true";
let currentEditId = null;
let currentImageData = null;

// Default admin password
if (!localStorage.getItem("adminPassword")) {
    localStorage.setItem("adminPassword", "admin123");
}

// === HELPER FUNCTIONS ===

// Update PayWay link
document.getElementById("payText").textContent = "PayWay";
document.getElementById("payText").href = PAYWAY_LINK;

// Secret Admin Unlock
function unlockAdmin() {
    const password = prompt("Enter admin unlock password:");
    if (password === SECRET_UNLOCK_PASSWORD) {
        adminUnlocked = true;
        localStorage.setItem("adminUnlocked", "true");
        adminBtn.style.display = "inline-block";
        alert("âœ“ Admin access unlocked! Admin button is now visible.");
    } else if (password) {
        alert("âœ— Incorrect password!");
    }
}

// Image handling with preview & resize
imageInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    imageError.classList.add("hidden");

    if (!file.type.startsWith('image/')) return showImageError("Select an image file!");
    if (file.size > 5*1024*1024) return showImageError("Max size 5MB");

    const reader = new FileReader();
    reader.onload = async () => {
        const img = new Image();
        img.onload = async () => {
            if(img.width<400 || img.height<400){
                imageError.textContent = `Image small (${img.width}x${img.height}px). Recommended 800x800px.`;
                imageError.classList.remove("hidden");
                imageError.style.color = "#e67e22";
                imageError.style.background = "#fff4e6";
            }
            preview.src = reader.result;
            preview.classList.remove("hidden");
            currentImageData = await resizeImage(reader.result,800,800);
        };
        img.src = reader.result;
    };
    reader.readAsDataURL(file);
};

function showImageError(msg){
    imageError.textContent = msg;
    imageError.classList.remove("hidden");
    imageError.style.color="#c33";
    imageError.style.background="#fee";
    imageInput.value="";
    preview.classList.add("hidden");
    currentImageData=null;
}

async function resizeImage(base64,maxWidth=800,maxHeight=800){
    return new Promise(resolve=>{
        const img=new Image();
        img.onload=()=>{
            let width=img.width,height=img.height;
            if(width>maxWidth){height=Math.round(height*maxWidth/width);width=maxWidth;}
            if(height>maxHeight){width=Math.round(width*maxHeight/height);height=maxHeight;}
            const canvas=document.createElement("canvas");
            canvas.width=width;canvas.height=height;
            const ctx=canvas.getContext("2d");
            ctx.imageSmoothingEnabled=true;
            ctx.imageSmoothingQuality='high';
            ctx.drawImage(img,0,0,width,height);
            resolve(canvas.toDataURL("image/jpeg",0.85));
        };
        img.src=base64;
    });
}

// Drag & Drop image
document.addEventListener('DOMContentLoaded',()=>{
    const uploadContainer=document.querySelector('.image-upload-container');
    if(uploadContainer){
        ['dragenter','dragover','dragleave','drop'].forEach(e=>{
            uploadContainer.addEventListener(e,preventDefaults,false);
            document.body.addEventListener(e,preventDefaults,false);
        });
        ['dragenter','dragover'].forEach(e=>uploadContainer.addEventListener(e,()=>{uploadContainer.style.borderColor='#4a90e2';uploadContainer.style.background='#e8f4ff'},false));
        ['dragleave','drop'].forEach(e=>uploadContainer.addEventListener(e,()=>{uploadContainer.style.borderColor='#ddd';uploadContainer.style.background='#fafafa'},false));
        uploadContainer.addEventListener('drop',e=>{
            const files=e.dataTransfer.files;
            if(files.length>0){imageInput.files=files;imageInput.dispatchEvent(new Event('change',{bubbles:true}));}
        },false);
    }
});

    <script>
// === ADMIN FUNCTIONS ===

// Save or Edit Product
function saveProduct() {
    const name = document.getElementById("name").value.trim();
    const price = parseFloat(document.getElementById("price").value);
    const stock = parseInt(document.getElementById("stock").value);
    const sizes = document.getElementById("size").value.split(",").map(s=>s.trim()).filter(s=>s);
    
    if(!name || isNaN(price) || isNaN(stock) || !currentImageData) {
        alert("Please fill all fields and select a valid image.");
        return;
    }

    if(currentEditId !== null){
        // Edit existing
        const index = products.findIndex(p=>p.id===currentEditId);
        products[index] = { ...products[index], name, price, stock, sizes, image: currentImageData };
        currentEditId = null;
        cancelEditBtn.classList.add("hidden");
    } else {
        // Add new
        const id = Date.now();
        products.push({ id, name, price, stock, sizes, image: currentImageData });
    }

    localStorage.setItem("products", JSON.stringify(products));
    renderProducts();
    renderAdminEdit();
    resetAdminForm();
}

// Reset admin form
function resetAdminForm(){
    document.getElementById("name").value="";
    document.getElementById("price").value="";
    document.getElementById("stock").value="";
    document.getElementById("size").value="";
    imageInput.value="";
    preview.classList.add("hidden");
    currentImageData=null;
}

// Edit product
function editProduct(id){
    const product = products.find(p=>p.id===id);
    if(!product) return;
    document.getElementById("name").value = product.name;
    document.getElementById("price").value = product.price;
    document.getElementById("stock").value = product.stock;
    document.getElementById("size").value = product.sizes.join(", ");
    preview.src = product.image;
    preview.classList.remove("hidden");
    currentImageData = product.image;
    currentEditId = id;
    cancelEditBtn.classList.remove("hidden");
}

// Cancel edit
function cancelEdit(){
    currentEditId=null;
    resetAdminForm();
    cancelEditBtn.classList.add("hidden");
}

// Delete product
function deleteProduct(id){
    if(confirm("Are you sure you want to delete this product?")){
        products = products.filter(p=>p.id!==id);
        localStorage.setItem("products", JSON.stringify(products));
        renderProducts();
        renderAdminEdit();
    }
}

// Change admin password
function changePassword(){
    const oldPass = document.getElementById("oldPass").value;
    const newPass = document.getElementById("newPass").value;
    const confirmPass = document.getElementById("confirmPass").value;
    const current = localStorage.getItem("adminPassword");

    if(oldPass !== current){
        showPasswordMessage("Old password incorrect!", true);
        return;
    }
    if(newPass.length < 4){
        showPasswordMessage("New password too short!", true);
        return;
    }
    if(newPass !== confirmPass){
        showPasswordMessage("Passwords do not match!", true);
        return;
    }
    localStorage.setItem("adminPassword", newPass);
    showPasswordMessage("Password changed successfully!", false);
    document.getElementById("oldPass").value="";
    document.getElementById("newPass").value="";
    document.getElementById("confirmPass").value="";
}

function showPasswordMessage(msg, isError){
    passwordMessage.textContent = msg;
    passwordMessage.classList.remove("hidden");
    passwordMessage.classList.toggle("alert-error", isError);
    passwordMessage.classList.toggle("alert-success", !isError);
    setTimeout(()=>{passwordMessage.classList.add("hidden");},4000);
}

// Admin Login
function openAdmin(){
    if(adminUnlocked){
        store.classList.add("hidden");
        admin.classList.remove("hidden");
    } else {
        loginModal.style.display="flex";
    }
}

function login(){
    const username = document.getElementById("user").value;
    const password = document.getElementById("pass").value;
    if(username==="admin" && password===localStorage.getItem("adminPassword")){
        localStorage.setItem("admin","true");
        isAdmin=true;
        loginModal.style.display="none";
        admin.classList.remove("hidden");
        store.classList.add("hidden");
        adminBtn.style.display="inline-block";
        renderAdminEdit();
        renderOrders();
    } else {
        alert("Incorrect credentials!");
    }
}

function logout(){
    localStorage.removeItem("admin");
    isAdmin=false;
    admin.classList.add("hidden");
    store.classList.remove("hidden");
    adminBtn.style.display="none";
}

// === PRODUCT RENDER ===
function renderProducts(){
    productGrid.innerHTML="";
    products.forEach(product=>{
        const card=document.createElement("div");
        card.className="card";
        card.innerHTML=`
            <img src="${product.image}" alt="${product.name}">
            <div class="card-body">
                <h4>${product.name}</h4>
                <p class="price">$${product.price.toFixed(2)}</p>
                <div class="product-sizes">${product.sizes.map(s=>`<span class="size-tag">${s}</span>`).join("")}</div>
                <p>Stock: ${product.stock}</p>
                <button class="btn btn-orange" onclick="addToCart(${product.id})" ${product.stock<=0?"disabled":""}>Add to Cart</button>
            </div>
        `;
        productGrid.appendChild(card);
    });
}

// === ADMIN EDIT RENDER ===
function renderAdminEdit(){
    editProductsDiv.innerHTML="";
    products.forEach(p=>{
        const div=document.createElement("div");
        div.className="order";
        div.innerHTML=`
            <h4>${p.name}</h4>
            <p>Price: $${p.price.toFixed(2)} | Stock: ${p.stock}</p>
            <button class="edit-btn" onclick="editProduct(${p.id})">Edit</button>
            <button class="edit-btn btn-red" onclick="deleteProduct(${p.id})">Delete</button>
        `;
        editProductsDiv.appendChild(div);
    });
}

// === CART FUNCTIONS ===
function addToCart(id){
    const product = products.find(p=>p.id===id);
    if(!product || product.stock<=0) return;
    const cartItem = cart.find(c=>c.id===id);
    if(cartItem){
        if(cartItem.qty<product.stock){
            cartItem.qty++;
        } else {
            alert("Not enough stock!");
        }
    } else {
        cart.push({ id: product.id, name: product.name, price: product.price, qty: 1 });
    }
    localStorage.setItem("cart", JSON.stringify(cart));
    updateCartCount();
}

function updateCartCount(){
    cartCount.textContent = cart.reduce((a,b)=>a+b.qty,0);
}

function openCart(){
    cartModal.style.display="flex";
    renderCartItems();
}

function closeCart(){
    cartModal.style.display="none";
}

function renderCartItems(){
    const container = document.getElementById("cartItems");
    const totalEl = document.getElementById("cartTotal");
    container.innerHTML="";
    let total=0;
    if(cart.length===0){
        container.innerHTML="<p>Your cart is empty.</p>";
    }
    cart.forEach(item=>{
        const div=document.createElement("div");
        div.className="cart-item";
        div.innerHTML=`
            <span>${item.name} x ${item.qty}</span>
            <span>$${(item.price*item.qty).toFixed(2)}</span>
        `;
        container.appendChild(div);
        total += item.price*item.qty;
    });
    totalEl.textContent = `Total: $${total.toFixed(2)}`;
}

// === ORDER FUNCTIONS ===
function sendOrder(){
    const cname = document.getElementById("cname").value.trim();
    const cphone = document.getElementById("cphone").value.trim();
    const caddr = document.getElementById("caddr").value.trim();
    if(!cname || !cphone || !caddr || cart.length===0){
        alert("Please fill all customer info and cart not empty.");
        return;
    }
    // Prepare message
    let message = `Hello, I would like to order from ${PAGE_NAME}:\n`;
    cart.forEach(item=>{
        message += `${item.name} x ${item.qty} = $${(item.price*item.qty).toFixed(2)}\n`;
        // Reduce stock
        const p = products.find(pr=>pr.id===item.id);
        if(p) p.stock -= item.qty;
    });
    message += `\nName: ${cname}\nPhone: ${cphone}\nAddress: ${caddr}`;

    localStorage.setItem("products", JSON.stringify(products));
    localStorage.setItem("cart", JSON.stringify([]));
    cart=[];
    updateCartCount();
    renderProducts();
    renderAdminEdit();
    closeCart();

    // Cross-browser safe Messenger link
    const encoded = encodeURIComponent(message);
    const link = `https://m.me/Goatkids?ref=${encoded}`;
    window.open(link, "_blank");
}

// PayWay simulation
function payViaPayWay(){
    window.open(PAYWAY_LINK,"_blank");
}

// === ORDERS HISTORY (Admin) ===
function renderOrders(){
    const ordersDiv = document.getElementById("orders");
    ordersDiv.innerHTML="";
    orders.forEach(o=>{
        const div = document.createElement("div");
        div.className="order";
        div.textContent = o;
        ordersDiv.appendChild(div);
    });
}

// === INIT ===
document.addEventListener("DOMContentLoaded",()=>{
    updateCartCount();
    renderProducts();
    if(adminUnlocked) adminBtn.style.display="inline-block";
});
</script>

</body>
</html>

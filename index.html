<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* { box-sizing: border-box; font-family: Segoe UI, system-ui, sans-serif; }
body { margin: 0; background: #f5f6f8; }
header { background: #fff; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,.1); }
.container { max-width: 1200px; margin: auto; padding: 20px; }
.flex { display: flex; justify-content: space-between; align-items: center; }
nav button { margin-left: 10px; border: none; background: #eee; padding: 8px 14px; border-radius: 6px; cursor: pointer; transition: background 0.3s; }
nav button:hover { background: #ddd; }
.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; }
.card { background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,.1); position: relative; transition: transform 0.3s; }
.card:hover { transform: translateY(-5px); }
.card img { width: 100%; height: 180px; object-fit: cover; }
.card-body { padding: 12px; }
.price { color: #ff6b35; font-weight: bold; font-size: 1.2em; }
.btn { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; margin-top: 5px; transition: opacity 0.3s; }
.btn:hover { opacity: 0.9; }
.btn-orange { background: #ff6b35; color: #fff; }
.btn-blue { background: #4a90e2; color: #fff; }
.btn-red { background: #e74c3c; color: #fff; }
.btn-gray { background: #95a5a6; color: #fff; }
.hidden { display: none !important; }
.modal { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 420px; max-height: 90vh; overflow-y: auto; }
input, textarea, select { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; }
.cart-item { display: flex; justify-content: space-between; margin-bottom: 6px; padding: 8px; border-bottom: 1px solid #eee; }
.preview { width: 100%; height: 160px; object-fit: cover; border-radius: 6px; margin-bottom: 8px; }
.order { background: #fff; padding: 10px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #4a90e2; }
.alert-stock { color: #e74c3c; font-weight: bold; margin-top: 5px; }
.edit-btn { background: #4a90e2; color: #fff; width: 100%; margin-top: 5px; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
.alert { padding: 10px; border-radius: 4px; margin-bottom: 10px; }
.alert-error { background: #fee; color: #c33; border: 1px solid #fcc; }
</style>
</head>
<body>

<header>
<div class="container flex">
<b>ðŸ›’ My Store</b>
<nav>
<button onclick="openCart()">Cart (<span id="cartCount">0</span>)</button>
<button onclick="openAdmin()">Admin</button>
</nav>
</div>
</header>

<div class="container">

<!-- STORE -->
<section id="store">
<div class="grid" id="productGrid"></div>
</section>

<!-- ADMIN -->
<section id="admin" class="hidden">
<h2>Admin Panel</h2>
<div class="form-group">
<label for="name">Product Name</label>
<input id="name" placeholder="Enter product name">
</div>
<div class="form-group">
<label for="price">Price ($)</label>
<input id="price" type="number" min="0" step="0.01" placeholder="0.00">
</div>
<div class="form-group">
<label for="stock">Stock Quantity</label>
<input id="stock" type="number" min="0" placeholder="0">
</div>
<div class="form-group">
<label for="size">Sizes (comma separated)</label>
<input id="size" placeholder="S, M, L, XL">
</div>
<div class="form-group">
<label for="image">Product Image</label>
<input type="file" id="image" accept="image/*">
<div id="imageError" class="alert alert-error hidden"></div>
</div>
<img id="preview" class="preview hidden">
<div class="flex">
<button id="saveProductBtn" class="btn btn-orange" onclick="saveProduct()">Add Product</button>
<button id="cancelEditBtn" class="btn btn-gray hidden" onclick="cancelEdit()" style="margin-left: 10px;">Cancel Edit</button>
</div>

<h3>Order History</h3>
<div id="orders"></div>

<h3>Edit Products</h3>
<div id="editProducts"></div>

<button class="btn btn-red" onclick="logout()" style="margin-top: 20px;">Logout</button>
</section>

</div>

<!-- LOGIN MODAL -->
<div class="modal" id="loginModal">
<div class="modal-content">
<h3>Admin Login</h3>
<div class="form-group">
<label for="user">Username</label>
<input id="user" value="admin">
</div>
<div class="form-group">
<label for="pass">Password</label>
<input id="pass" type="password" value="admin123">
</div>
<button class="btn btn-blue" onclick="login()">Login</button>
</div>
</div>

<!-- CART MODAL -->
<div class="modal" id="cartModal">
<div class="modal-content">
<h3>Your Cart</h3>
<div id="cartItems"></div>
<h4 id="cartTotal"></h4>

<h4>Customer Information</h4>
<div class="form-group">
<label for="cname">Full Name</label>
<input id="cname" placeholder="Enter your full name">
</div>
<div class="form-group">
<label for="cphone">Phone Number</label>
<input id="cphone" placeholder="Enter phone number">
</div>
<div class="form-group">
<label for="caddr">Delivery Address</label>
<textarea id="caddr" placeholder="Enter delivery address" rows="3"></textarea>
</div>

<div class="form-group">
<p><b>Payment Method:</b></p>
<p>ðŸ’³ Pay online via <a id="payText" href="#" target="_blank">PayWay</a></p>
</div>

<div class="flex">
<button class="btn btn-orange" onclick="payViaPayWay()">ðŸ’³ Pay via PayWay</button>
<button class="btn btn-blue" onclick="sendOrder()">ðŸ“© Order via Messenger</button>
<button class="btn btn-red" onclick="closeCart()">Close</button>
</div>
</div>
</div>

<script>
// Global Variables
const productGrid = document.getElementById("productGrid");
const cartCount = document.getElementById("cartCount");
const store = document.getElementById("store");
const admin = document.getElementById("admin");
const loginModal = document.getElementById("loginModal");
const cartModal = document.getElementById("cartModal");
const editProductsDiv = document.getElementById("editProducts");
const imageInput = document.getElementById("image");
const preview = document.getElementById("preview");
const imageError = document.getElementById("imageError");
const saveProductBtn = document.getElementById("saveProductBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");

const PAYWAY_LINK = "https://link.payway.com.kh/08407860s";
const PAGE_NAME = "Goatkids";

// Load data from localStorage
let products = JSON.parse(localStorage.getItem("products")) || [];
let cart = JSON.parse(localStorage.getItem("cart")) || [];
let orders = JSON.parse(localStorage.getItem("orders")) || [];
let isAdmin = localStorage.getItem("admin") === "true";
let currentEditId = null;
let currentImageData = null; // Store the image data temporarily

// Initialize
document.getElementById("payText").textContent = "PayWay";
document.getElementById("payText").href = PAYWAY_LINK;

// Image Handling
imageInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    // Reset error
    imageError.classList.add("hidden");
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
        showImageError("Please select an image file (JPEG, PNG, etc.)");
        return;
    }
    
    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showImageError("Image too large! Maximum size is 5MB");
        return;
    }
    
    const reader = new FileReader();
    reader.onload = async () => {
        // Check image dimensions
        const img = new Image();
        img.onload = async () => {
            if (img.width > 4000 || img.height > 4000) {
                showImageError("Image dimensions too large! Maximum is 4000x4000 pixels");
                imageInput.value = "";
            } else {
                // Resize and store the image
                preview.src = reader.result;
                preview.classList.remove("hidden");
                currentImageData = await resizeImage(reader.result);
            }
        };
        img.src = reader.result;
    };
    reader.readAsDataURL(file);
};

function showImageError(message) {
    imageError.textContent = message;
    imageError.classList.remove("hidden");
    imageInput.value = "";
    preview.classList.add("hidden");
    currentImageData = null;
}

async function resizeImage(base64, max = 600) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
            const scale = Math.min(max / img.width, max / img.height, 1);
            const canvas = document.createElement("canvas");
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL("image/jpeg", 0.8));
        };
        img.src = base64;
    });
}

// Admin Functions
function openAdmin() {
    if (!isAdmin) {
        loginModal.style.display = "flex";
        return;
    }
    store.classList.add("hidden");
    admin.classList.remove("hidden");
    renderOrders();
    renderEditProducts();
    resetForm();
}

function login() {
    const user = document.getElementById("user").value;
    const pass = document.getElementById("pass").value;
    
    // Simple authentication (replace with secure method in production)
    if (user === "admin" && pass === "admin123") {
        isAdmin = true;
        localStorage.setItem("admin", "true");
        loginModal.style.display = "none";
        openAdmin();
    } else {
        alert("Invalid username or password");
    }
}

function logout() {
    isAdmin = false;
    localStorage.removeItem("admin");
    admin.classList.add("hidden");
    store.classList.remove("hidden");
    resetForm();
}

// Product Management
async function saveProduct() {
    const name = document.getElementById("name").value.trim();
    const price = parseFloat(document.getElementById("price").value);
    const stock = parseInt(document.getElementById("stock").value);
    const size = document.getElementById("size").value;
    
    // Validation
    if (!name) {
        alert("Product name is required");
        return;
    }
    
    if (isNaN(price) || price < 0) {
        alert("Please enter a valid price (minimum 0)");
        return;
    }
    
    if (isNaN(stock) || stock < 0) {
        alert("Please enter a valid stock quantity (minimum 0)");
        return;
    }
    
    // For NEW products, require an image
    if (currentEditId === null && !currentImageData) {
        alert("Please select an image for the new product");
        return;
    }
    
    const sizeValues = size.split(",").map(s => s.trim()).filter(s => s);
    
    if (currentEditId !== null) {
        // Update existing product
        const product = products.find(p => p.id === currentEditId);
        if (product) {
            product.name = name;
            product.price = price;
            product.stock = stock;
            product.sizes = sizeValues;
            
            // Only update image if a new one was selected
            if (currentImageData) {
                product.image = currentImageData;
            }
        }
    } else {
        // Add new product
        const newProduct = {
            id: Date.now(),
            name: name,
            price: price,
            stock: stock,
            sizes: sizeValues,
            image: currentImageData
        };
        
        products.push(newProduct);
        console.log("Added new product:", newProduct); // Debug log
    }
    
    // Save to localStorage
    localStorage.setItem("products", JSON.stringify(products));
    console.log("Products in localStorage:", products); // Debug log
    
    // Reset and refresh
    resetForm();
    render();
    renderEditProducts();
    
    // Show success message
    alert(currentEditId !== null ? "Product updated successfully!" : "Product added successfully!");
}

function editProduct(id) {
    const product = products.find(p => p.id === id);
    if (!product) return;
    
    document.getElementById("name").value = product.name;
    document.getElementById("price").value = product.price;
    document.getElementById("stock").value = product.stock;
    document.getElementById("size").value = product.sizes.join(", ");
    
    if (product.image) {
        preview.src = product.image;
        preview.classList.remove("hidden");
        currentImageData = product.image; // Store current image
    }
    
    currentEditId = id;
    saveProductBtn.textContent = "Update Product";
    saveProductBtn.className = "btn btn-blue";
    cancelEditBtn.classList.remove("hidden");
}

function resetForm() {
    document.getElementById("name").value = "";
    document.getElementById("price").value = "";
    document.getElementById("stock").value = "";
    document.getElementById("size").value = "";
    imageInput.value = "";
    preview.src = "";
    preview.classList.add("hidden");
    imageError.classList.add("hidden");
    currentEditId = null;
    currentImageData = null;
    saveProductBtn.textContent = "Add Product";
    saveProductBtn.className = "btn btn-orange";
    cancelEditBtn.classList.add("hidden");
}

function cancelEdit() {
    resetForm();
}

// Render Products
function render() {
    productGrid.innerHTML = "";
    
    if (products.length === 0) {
        productGrid.innerHTML = '<p style="text-align: center; grid-column: 1/-1; padding: 40px;">No products available. Add some in admin panel!</p>';
        return;
    }
    
    console.log("Rendering products:", products); // Debug log
    
    products.forEach(product => {
        const sizeOptions = product.sizes && product.sizes.length > 0 
            ? product.sizes.map(size => `<option value="${size}">${size}</option>`).join("")
            : '<option value="N/A">N/A</option>';
        
        const isOutOfStock = product.stock === 0;
        const productImage = product.image || getDefaultImage();
        
        const productCard = `
        <div class="card">
            <img src="${productImage}" alt="${product.name}">
            <div class="card-body">
                <h4>${product.name}</h4>
                <div class="price">$${product.price.toFixed(2)}</div>
                <div>Stock: ${product.stock}</div>
                <select id="sizeSelect-${product.id}">
                    ${sizeOptions}
                </select>
                <button class="btn btn-orange" onclick="addToCart(${product.id})" 
                    ${isOutOfStock ? 'disabled' : ''}>
                    ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                </button>
                ${isOutOfStock ? '<div class="alert-stock">Out of Stock!</div>' : ''}
            </div>
        </div>`;
        
        productGrid.innerHTML += productCard;
    });
    
    updateCartCount();
}

// Helper function for default image
function getDefaultImage() {
    return 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZpbGw9IiM5OTkiIGZvbnQtZmFtaWx5PSJBcmlhbCI+UHJvZHVjdDwvdGV4dD48L3N2Zz4=';
}

// Cart Functions
function addToCart(id) {
    const product = products.find(p => p.id === id);
    if (!product || product.stock <= 0) {
        alert("This product is out of stock!");
        return;
    }
    
    const selectedSize = document.getElementById(`sizeSelect-${id}`)?.value || "N/A";
    const existingItem = cart.find(item => item.id === id && item.size === selectedSize);
    
    if (existingItem) {
        if (existingItem.qty >= product.stock) {
            alert("Not enough stock available!");
            return;
        }
        existingItem.qty++;
    } else {
        cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            size: selectedSize,
            qty: 1
        });
    }
    
    product.stock--;
    localStorage.setItem("products", JSON.stringify(products));
    localStorage.setItem("cart", JSON.stringify(cart));
    render();
}

function updateCartCount() {
    const totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
    cartCount.textContent = totalItems;
}

function openCart() {
    renderCart();
    cartModal.style.display = "flex";
}

function closeCart() {
    cartModal.style.display = "none";
}

function renderCart() {
    const cartItems = document.getElementById("cartItems");
    
    if (cart.length === 0) {
        cartItems.innerHTML = '<p style="text-align: center;">Your cart is empty</p>';
        document.getElementById("cartTotal").textContent = "Total: $0.00";
        return;
    }
    
    let html = "";
    let total = 0;
    
    cart.forEach((item, index) => {
        const itemTotal = item.price * item.qty;
        total += itemTotal;
        
        html += `
        <div class="cart-item">
            <div>
                <strong>${item.name}</strong> (${item.size})
                <br><small>$${item.price.toFixed(2)} Ã— ${item.qty}</small>
            </div>
            <div>
                $${itemTotal.toFixed(2)}
                <button onclick="removeFromCart(${index})" style="margin-left: 10px; color: #e74c3c; border: none; background: none; cursor: pointer; font-size: 18px;">Ã—</button>
            </div>
        </div>`;
    });
    
    cartItems.innerHTML = html;
    document.getElementById("cartTotal").textContent = `Total: $${total.toFixed(2)}`;
}

function removeFromCart(index) {
    const item = cart[index];
    const product = products.find(p => p.id === item.id);
    
    if (product) {
        product.stock += item.qty;
    }
    
    cart.splice(index, 1);
    localStorage.setItem("products", JSON.stringify(products));
    localStorage.setItem("cart", JSON.stringify(cart));
    render();
    renderCart();
}

function payViaPayWay() {
    window.open(PAYWAY_LINK, '_blank');
}

function sendOrder() {
    const name = document.getElementById("cname").value.trim();
    const phone = document.getElementById("cphone").value.trim();
    const address = document.getElementById("caddr").value.trim();
    
    if (!name || !phone || !address) {
        alert("Please fill in all customer information");
        return;
    }
    
    if (cart.length === 0) {
        alert("Your cart is empty");
        return;
    }
    
    let message = `ðŸ›’ New Order%0A%0A`;
    message += `ðŸ‘¤ Customer: ${name}%0A`;
    message += `ðŸ“ž Phone: ${phone}%0A`;
    message += `ðŸ“ Address: ${address}%0A%0A`;
    message += `ðŸ“¦ Order Details:%0A`;
    
    let total = 0;
    cart.forEach(item => {
        const itemTotal = item.price * item.qty;
        total += itemTotal;
        message += `â€¢ ${item.name} (${item.size}) Ã— ${item.qty} = $${itemTotal.toFixed(2)}%0A`;
    });
    
    message += `%0AðŸ’° Total: $${total.toFixed(2)}%0A`;
    message += `ðŸ’³ Pay online: ${PAYWAY_LINK}`;
    
    // Save order to history
    orders.push({
        id: Date.now(),
        date: new Date().toLocaleString(),
        name: name,
        phone: phone,
        address: address,
        total: total,
        items: [...cart],
        status: 'pending'
    });
    
    localStorage.setItem("orders", JSON.stringify(orders));
    
    // Clear cart
    cart = [];
    localStorage.removeItem("cart");
    
    // Open Messenger
    window.open(`https://m.me/${PAGE_NAME}?text=${message}`, '_blank');
    
    closeCart();
    render();
    renderOrders();
}

// Order History
function renderOrders() {
    const ordersDiv = document.getElementById("orders");
    
    if (orders.length === 0) {
        ordersDiv.innerHTML = '<p>No orders yet.</p>';
        return;
    }
    
    ordersDiv.innerHTML = orders.map(order => `
        <div class="order">
            <strong>Order #${order.id}</strong><br>
            <small>${order.date}</small><br>
            ${order.name} (${order.phone})<br>
            Total: $${order.total.toFixed(2)}<br>
            Status: <span style="color: ${order.status === 'pending' ? '#e67e22' : '#27ae60'}">${order.status}</span>
        </div>
    `).join("");
}

// Admin Edit Products List
function renderEditProducts() {
    editProductsDiv.innerHTML = "";
    
    if (products.length === 0) {
        editProductsDiv.innerHTML = '<p>No products to edit.</p>';
        return;
    }
    
    products.forEach(product => {
        editProductsDiv.innerHTML += `
        <div class="order">
            <strong>${product.name}</strong><br>
            Price: $${product.price.toFixed(2)} | Stock: ${product.stock}<br>
            Sizes: ${product.sizes ? product.sizes.join(", ") : "N/A"}<br>
            <button class="edit-btn" onclick="editProduct(${product.id})">Edit</button>
        </div>`;
    });
}

// Initialization
function init() {
    render();
    updateCartCount();
    
    // Check if admin is already logged in
    if (isAdmin) {
        store.classList.add("hidden");
        admin.classList.remove("hidden");
        renderOrders();
        renderEditProducts();
    }
}

// Start the application
init();
</script>

</body>
</html>

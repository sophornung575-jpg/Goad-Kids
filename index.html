<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Goad Kids Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
/* [Keep all your existing CSS styles exactly as they are] */
</style>
</head>
<body>

<!-- [Keep all your existing HTML exactly as it is] -->

<script>
// ====================
// FIXED COOKIE-BASED STORAGE
// ====================

// Improved cookie helper functions
function setCookie(name, value, days = 30) {
    try {
        // Handle large data by compressing/splitting if needed
        let valueStr;
        try {
            valueStr = JSON.stringify(value);
        } catch (e) {
            console.error("Failed to stringify value for cookie", name, e);
            return false;
        }
        
        // Check size and warn if too large
        if (valueStr.length > 2000) {
            console.warn(`Cookie ${name} is large: ${valueStr.length} chars`);
            
            // If it's the products cookie and very large, compress images
            if (name === "goad_products" && valueStr.length > 3000) {
                console.log("Compressing product data...");
                value = compressProductImages(value);
                valueStr = JSON.stringify(value);
            }
        }
        
        const d = new Date();
        d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
        const expires = "expires=" + d.toUTCString();
        
        // Use encodeURIComponent to handle special characters
        const encodedValue = encodeURIComponent(valueStr);
        
        // Set the cookie
        document.cookie = name + "=" + encodedValue + ";" + expires + ";path=/;SameSite=Lax";
        
        // Verify it was set
        const check = getCookie(name);
        if (!check) {
            console.error("Failed to set cookie:", name);
            return false;
        }
        
        return true;
    } catch (error) {
        console.error("Error setting cookie:", name, error);
        return false;
    }
}

function getCookie(name) {
    try {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i = 0; i < ca.length; i++) {
            let c = ca[i].trim();
            if (c.indexOf(nameEQ) === 0) {
                const cookieValue = decodeURIComponent(c.substring(nameEQ.length, c.length));
                try {
                    return JSON.parse(cookieValue);
                } catch (e) {
                    console.error("Failed to parse cookie:", name, e);
                    return null;
                }
            }
        }
    } catch (error) {
        console.error("Error reading cookie:", error);
    }
    return null;
}

function deleteCookie(name) {
    document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/';
}

// Compress product images to reduce cookie size
function compressProductImages(products) {
    return products.map(product => {
        // Create a copy to avoid modifying original
        const compressedProduct = { ...product };
        
        // If image is very large base64, replace with placeholder
        if (compressedProduct.image && compressedProduct.image.length > 10000) {
            console.log("Image too large, compressing...");
            // Keep only first 5000 chars of base64
            compressedProduct.image = compressedProduct.image.substring(0, 5000);
        }
        
        return compressedProduct;
    });
}

// ====================
// GLOBAL VARIABLES
// ====================
const productGrid = document.getElementById("productGrid");
const cartCount = document.getElementById("cartCount");
const store = document.getElementById("store");
const admin = document.getElementById("admin");
const loginModal = document.getElementById("loginModal");
const cartModal = document.getElementById("cartModal");
const editProductsDiv = document.getElementById("editProducts");
const imageInput = document.getElementById("image");
const preview = document.getElementById("preview");
const imageError = document.getElementById("imageError");
const saveProductBtn = document.getElementById("saveProductBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const passwordMessage = document.getElementById("passwordMessage");
const adminBtn = document.getElementById("adminBtn");

const PAYWAY_LINK = "https://link.payway.com.kh/08407860s";
const PAGE_NAME = "Goatkids";
const SECRET_UNLOCK_PASSWORD = "admin123";

// Initialize global data
let products = [];
let cart = [];
let orders = [];
let isAdmin = false;
let adminUnlocked = false;
let currentEditId = null;
let currentImageData = null;

// ====================
// DATA STORAGE FUNCTIONS - FIXED
// ====================

function loadData() {
    console.log("Loading data from cookies...");
    
    try {
        // Load products
        const productsData = getCookie("goad_products");
        products = Array.isArray(productsData) ? productsData : [];
        console.log("Loaded products:", products.length);
        
        // Load cart
        const cartData = getCookie("goad_cart");
        cart = Array.isArray(cartData) ? cartData : [];
        console.log("Loaded cart items:", cart.length);
        
        // Load orders
        const ordersData = getCookie("goad_orders");
        orders = Array.isArray(ordersData) ? ordersData : [];
        console.log("Loaded orders:", orders.length);
        
        // Load admin states
        isAdmin = getCookie("goad_admin") === true;
        adminUnlocked = getCookie("goad_unlocked") === true;
        
        console.log("Admin status - isAdmin:", isAdmin, "adminUnlocked:", adminUnlocked);
        
    } catch (error) {
        console.error("Error in loadData:", error);
        // Reset to empty arrays
        products = [];
        cart = [];
        orders = [];
    }
}

function saveData() {
    console.log("Saving data to cookies...");
    
    try {
        // Save products
        const productsSaved = setCookie("goad_products", products, 90);
        console.log("Products saved:", productsSaved, "Count:", products.length);
        
        // Save cart
        const cartSaved = setCookie("goad_cart", cart, 7);
        console.log("Cart saved:", cartSaved, "Count:", cart.length);
        
        // Save orders
        const ordersSaved = setCookie("goad_orders", orders, 90);
        console.log("Orders saved:", ordersSaved, "Count:", orders.length);
        
        // Save admin states with shorter expiry
        if (isAdmin) {
            setCookie("goad_admin", true, 1);
        }
        if (adminUnlocked) {
            setCookie("goad_unlocked", true, 7);
        }
        
        console.log("All data saved successfully");
        
    } catch (error) {
        console.error("Error in saveData:", error);
        alert("Error saving data. Please try again.");
    }
}

// Initialize admin password cookie
if (!getCookie("goad_password")) {
    setCookie("goad_password", "admin123", 365);
    console.log("Initial admin password set");
}

// ====================
// IMAGE HANDLING - FIXED
// ====================

imageInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    imageError.classList.add("hidden");
    
    if (!file.type.startsWith('image/')) {
        showImageError("Please select an image file (JPEG, PNG, GIF)");
        return;
    }
    
    // Reduce max size for cookies
    if (file.size > 1 * 1024 * 1024) { // 1MB max
        showImageError("Image too large! Maximum size is 1MB for cookie storage");
        return;
    }
    
    const reader = new FileReader();
    reader.onload = async () => {
        try {
            preview.src = reader.result;
            preview.classList.remove("hidden");
            
            // Resize to smaller dimensions for cookies
            currentImageData = await resizeImage(reader.result, 300, 300);
            console.log("Image loaded and resized");
        } catch (error) {
            console.error("Error processing image:", error);
            showImageError("Error processing image. Please try another image.");
        }
    };
    reader.onerror = () => {
        showImageError("Error reading image file");
    };
    reader.readAsDataURL(file);
};

function showImageError(message) {
    imageError.textContent = message;
    imageError.classList.remove("hidden");
    imageInput.value = "";
    preview.classList.add("hidden");
    currentImageData = null;
}

async function resizeImage(base64, maxWidth = 300, maxHeight = 300) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
            try {
                let width = img.width;
                let height = img.height;
                
                // Calculate new dimensions maintaining aspect ratio
                if (width > maxWidth) {
                    height = Math.round(height * maxWidth / width);
                    width = maxWidth;
                }
                
                if (height > maxHeight) {
                    width = Math.round(width * maxHeight / height);
                    height = maxHeight;
                }
                
                const canvas = document.createElement("canvas");
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, width, height);
                
                // Lower quality to reduce size for cookies
                const compressedBase64 = canvas.toDataURL("image/jpeg", 0.6);
                console.log("Image resized to:", width, "x", height, "Size:", compressedBase64.length, "chars");
                
                resolve(compressedBase64);
            } catch (error) {
                reject(error);
            }
        };
        img.onerror = reject;
        img.src = base64;
    });
}

// ====================
// PRODUCT MANAGEMENT - FIXED VERSION
// ====================

async function saveProduct() {
    console.log("saveProduct called");
    
    // Get form values
    const name = document.getElementById("name").value.trim();
    const priceInput = document.getElementById("price").value;
    const stockInput = document.getElementById("stock").value;
    const size = document.getElementById("size").value;
    
    console.log("Form values:", { name, priceInput, stockInput, size, currentEditId, hasImage: !!currentImageData });
    
    // Validation
    if (!name) {
        alert("Product name is required");
        return;
    }
    
    const price = parseFloat(priceInput);
    if (isNaN(price) || price < 0) {
        alert("Please enter a valid price (minimum 0)");
        return;
    }
    
    const stock = parseInt(stockInput);
    if (isNaN(stock) || stock < 0) {
        alert("Please enter a valid stock quantity (minimum 0)");
        return;
    }
    
    // For new products, image is required
    if (currentEditId === null && !currentImageData) {
        alert("Please select an image for the new product");
        return;
    }
    
    // Process sizes
    const sizeValues = size.split(",").map(s => s.trim()).filter(s => s);
    
    try {
        if (currentEditId !== null) {
            // Editing existing product
            console.log("Editing product with ID:", currentEditId);
            const productIndex = products.findIndex(p => p.id === currentEditId);
            if (productIndex !== -1) {
                products[productIndex] = {
                    ...products[productIndex],
                    name: name,
                    price: price,
                    stock: stock,
                    sizes: sizeValues,
                    image: currentImageData || products[productIndex].image
                };
                console.log("Product updated at index:", productIndex);
            }
        } else {
            // Adding new product
            console.log("Adding new product");
            const newProduct = {
                id: Date.now(),
                name: name,
                price: price,
                stock: stock,
                sizes: sizeValues,
                image: currentImageData
            };
            products.push(newProduct);
            console.log("New product added:", newProduct);
        }
        
        // Save to cookies
        console.log("Attempting to save", products.length, "products");
        saveData();
        
        // Reload data to verify
        loadData();
        
        // Reset form
        resetForm();
        
        // Update admin panel
        renderEditProducts();
        
        // Show success message
        const message = currentEditId !== null 
            ? "‚úÖ Product updated successfully!" 
            : "‚úÖ Product added successfully!";
        alert(message);
        
        console.log("Product operation completed successfully");
        
    } catch (error) {
        console.error("Error in saveProduct:", error);
        alert("‚ùå Error saving product. Please check console for details.");
    }
}

// ====================
// VIEW MANAGEMENT - FIXED
// ====================

function showStore() {
    console.log("showStore called");
    loadData();
    
    admin.classList.add("hidden");
    store.classList.remove("hidden");
    
    render();
    console.log("Store view shown with", products.length, "products");
}

function showAdmin() {
    console.log("showAdmin called");
    
    if (!isAdmin || !adminUnlocked) {
        console.log("Not authorized, redirecting to openAdmin");
        openAdmin();
        return;
    }
    
    store.classList.add("hidden");
    admin.classList.remove("hidden");
    
    renderOrders();
    renderEditProducts();
    console.log("Admin panel shown");
}

function openAdmin() {
    console.log("openAdmin called");
    
    if (!adminUnlocked) {
        console.log("Admin not unlocked, prompting for password");
        unlockAdmin();
        return;
    }
    
    if (!isAdmin) {
        console.log("Admin not logged in, showing login modal");
        showModal('loginModal');
        return;
    }
    
    showAdmin();
}

// Secret Admin Unlock Function
function unlockAdmin() {
    const password = prompt("Enter admin unlock password:");
    
    if (password === SECRET_UNLOCK_PASSWORD) {
        adminUnlocked = true;
        setCookie("goad_unlocked", true, 7);
        adminBtn.style.display = "inline-block";
        alert("‚úÖ Admin access unlocked! Admin button is now visible.");
        console.log("Admin unlocked");
    } else if (password) {
        alert("‚ùå Incorrect password!");
    }
}

// ====================
// RENDER FUNCTIONS - FIXED
// ====================

function render() {
    console.log("render called, products count:", products.length);
    
    if (!productGrid) {
        console.error("productGrid element not found!");
        return;
    }
    
    productGrid.innerHTML = "";
    
    if (!Array.isArray(products)) {
        console.error("products is not an array, resetting");
        products = [];
    }
    
    if (products.length === 0) {
        productGrid.innerHTML = `
            <div style="text-align: center; grid-column: 1/-1; padding: 40px 20px;">
                <div style="font-size: 40px; margin-bottom: 15px;">üõçÔ∏è</div>
                <h3 style="color: #666; margin-bottom: 10px;">No Products Available</h3>
                <p style="color: #999;">Add products in admin panel</p>
                <button class="btn btn-blue" onclick="openAdmin()" style="margin-top: 15px;">Go to Admin Panel</button>
            </div>`;
        console.log("No products to render");
        return;
    }
    
    console.log("Rendering", products.length, "products");
    
    products.forEach((product, index) => {
        if (!product || !product.id) {
            console.warn("Invalid product at index", index, product);
            return;
        }
        
        const sizeOptions = product.sizes && product.sizes.length > 0 
            ? product.sizes.map(size => `<option value="${size}">${size}</option>`).join("")
            : '<option value="">One Size</option>';
        
        const sizeTags = product.sizes && product.sizes.length > 0 
            ? `<div class="product-sizes">${product.sizes.map(size => `<span class="size-tag">${size}</span>`).join("")}</div>`
            : '';
        
        const isOutOfStock = product.stock === 0;
        const productImage = product.image || getDefaultImage();
        
        const cardHTML = `
        <div class="card">
            <div>
                <img src="${productImage}" alt="${product.name}" loading="lazy" onerror="this.src='${getDefaultImage()}'">
            </div>
            <div class="card-body">
                <h4 style="margin: 0 0 6px 0; font-size: 15px; line-height: 1.3;">${product.name}</h4>
                ${sizeTags}
                <div class="price">$${product.price ? product.price.toFixed(2) : '0.00'}</div>
                <div style="color: #666; margin: 6px 0; font-size: 13px;">Stock: <b>${product.stock || 0}</b></div>
                <select class="size-select" id="sizeSelect-${product.id}">
                    <option value="">Select Size</option>
                    ${sizeOptions}
                </select>
                <button class="btn btn-orange" onclick="addToCart(${product.id})" 
                    ${isOutOfStock ? 'disabled' : ''}>
                    ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                </button>
                ${isOutOfStock ? '<div class="alert-stock">Out of Stock!</div>' : ''}
            </div>
        </div>`;
        
        productGrid.innerHTML += cardHTML;
    });
    
    updateCartCount();
    console.log("Rendered", products.length, "products successfully");
}

function getDefaultImage() {
    return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5OTkiPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';
}

// ====================
// INITIALIZATION - FIXED
// ====================

function init() {
    console.log("====== INITIALIZING GOAD KIDS STORE ======");
    console.log("Browser:", navigator.userAgent);
    console.log("Cookies enabled:", navigator.cookieEnabled);
    
    // Initialize PayWay link
    const payText = document.getElementById("payText");
    if (payText) {
        payText.textContent = "PayWay";
        payText.href = PAYWAY_LINK;
    }
    
    // Load all data
    loadData();
    
    // Show/hide admin button
    if (adminBtn) {
        adminBtn.style.display = adminUnlocked ? "inline-block" : "none";
        console.log("Admin button display:", adminBtn.style.display);
    }
    
    // Render products (always do this first)
    render();
    
    // Determine which view to show
    if (isAdmin && adminUnlocked) {
        console.log("Showing admin panel");
        showAdmin();
    } else {
        console.log("Showing store");
        showStore();
    }
    
    console.log("====== STORE INITIALIZED ======");
    console.log("Products:", products.length);
    console.log("Cart items:", cart.length);
    console.log("Orders:", orders.length);
    console.log("Current cookies:", document.cookie ? "Available" : "None");
}

// ====================
// DEBUG HELPERS
// ====================

// Add a debug function to test saving
function debugSaveTest() {
    console.log("=== DEBUG SAVE TEST ===");
    console.log("Current products:", products);
    
    const testProduct = {
        id: Date.now(),
        name: "Test Product",
        price: 9.99,
        stock: 10,
        sizes: ["S", "M"],
        image: getDefaultImage()
    };
    
    console.log("Adding test product:", testProduct);
    products.push(testProduct);
    
    const saved = setCookie("goad_products", products, 90);
    console.log("Save successful:", saved);
    
    // Reload and render
    loadData();
    render();
    
    alert("Test product added. Check console for details.");
}

// Add debug button to header
window.addEventListener('DOMContentLoaded', function() {
    const headerNav = document.querySelector('nav');
    if (headerNav) {
        const debugBtn = document.createElement('button');
        debugBtn.textContent = "üêõ Test";
        debugBtn.onclick = debugSaveTest;
        debugBtn.style.background = "#9b59b6";
        debugBtn.style.color = "white";
        headerNav.appendChild(debugBtn);
    }
});

// ====================
// START THE APPLICATION
// ====================

// Wait for DOM to be ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM loaded, initializing...");
        setTimeout(init, 100);
    });
} else {
    console.log("DOM already loaded, initializing now...");
    setTimeout(init, 100);
}
</script>
</body>
</html>

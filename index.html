<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box;font-family:Segoe UI,system-ui}
body{margin:0;background:#f5f6f8}
header{background:#fff;padding:15px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.container{max-width:1200px;margin:auto;padding:20px}
.flex{display:flex;justify-content:space-between;align-items:center}
nav button{margin-left:10px;border:none;background:#eee;padding:8px 14px;border-radius:6px;cursor:pointer}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px}
.card{background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 4px 10px rgba(0,0,0,.1);position:relative;}
.card img{width:100%;height:180px;object-fit:cover}
.card-body{padding:12px}
.price{color:#ff6b35;font-weight:bold}
.btn{padding:8px 14px;border:none;border-radius:6px;cursor:pointer;margin-top:5px}
.btn-orange{background:#ff6b35;color:#fff}
.btn-blue{background:#4a90e2;color:#fff}
.btn-red{background:#e74c3c;color:#fff}
.hidden{display:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center}
.modal-content{background:#fff;padding:20px;border-radius:10px;width:90%;max-width:420px}
input,textarea,select{width:100%;padding:8px;margin-bottom:8px}
.cart-item{display:flex;justify-content:space-between;margin-bottom:6px}
.preview{width:100%;height:160px;object-fit:cover;border-radius:6px;margin-bottom:8px}
.order{background:#fff;padding:10px;margin-bottom:10px;border-radius:6px}
.alert-stock{color:red;font-weight:bold;margin-top:5px}
.edit-btn{background:#4a90e2;color:#fff;width:100%;margin-top:5px}
</style>
</head>
<body>

<header>
<div class="container flex">
<b>ðŸ›’ My Store</b>
<nav>
<button onclick="openCart()">Cart (<span id="cartCount">0</span>)</button>
<button onclick="openAdmin()">Admin</button>
</nav>
</div>
</header>

<div class="container">

<!-- STORE -->
<section id="store">
<div class="grid" id="productGrid"></div>
</section>

<!-- ADMIN -->
<section id="admin" class="hidden">
<h2>Admin Panel</h2>
<input id="name" placeholder="Product name">
<input id="price" type="number" placeholder="Price">
<input id="stock" type="number" placeholder="Stock">
<input id="size" placeholder="Sizes (comma separated, e.g. S,M,L)">
<input type="file" id="image" accept="image/*">
<img id="preview" class="preview hidden">
<button class="btn btn-orange" onclick="addProduct()">Add Product</button>

<h3>Order History</h3>
<div id="orders"></div>

<h3>Edit Products</h3>
<div id="editProducts"></div>

<button class="btn btn-red" onclick="logout()">Logout</button>
</section>

</div>

<!-- LOGIN -->
<div class="modal" id="loginModal">
<div class="modal-content">
<h3>Admin Login</h3>
<input id="user" value="admin">
<input id="pass" type="password" value="admin123">
<button class="btn btn-blue" onclick="login()">Login</button>
</div>
</div>

<!-- CART -->
<div class="modal" id="cartModal">
<div class="modal-content">
<h3>Your Cart</h3>
<div id="cartItems"></div>
<h4 id="cartTotal"></h4>

<h4>Customer Info</h4>
<input id="cname" placeholder="Full Name">
<input id="cphone" placeholder="Phone Number">
<textarea id="caddr" placeholder="Delivery Address"></textarea>

<p><b>Payment:</b><br>ðŸ’³ Pay online via <a id="payText" href="#" target="_blank"></a></p>

<button class="btn btn-orange" onclick="window.open(PAYWAY_LINK,'_blank')">ðŸ’³ Pay via PayWay</button>
<button class="btn btn-blue" onclick="sendOrder()">ðŸ“© Order via Messenger</button>
<button class="btn btn-red" onclick="closeCart()">Close</button>
</div>
</div>

<script>
const productGrid = document.getElementById("productGrid");
const cartCount = document.getElementById("cartCount");
const store = document.getElementById("store");
const admin = document.getElementById("admin");
const loginModal = document.getElementById("loginModal");
const cartModal = document.getElementById("cartModal");
const editProductsDiv = document.getElementById("editProducts");
const image = document.getElementById("image");
const preview = document.getElementById("preview");
const PAYWAY_LINK = "https://link.payway.com.kh/08407860s";
const PAGE_NAME = "Goatkids";
document.getElementById("payText").textContent = "Click here to pay";
document.getElementById("payText").href = PAYWAY_LINK;

let products = JSON.parse(localStorage.getItem("products")) || [];
let cart = JSON.parse(localStorage.getItem("cart")) || [];
let orders = JSON.parse(localStorage.getItem("orders")) || [];
let isAdmin = localStorage.getItem("admin")==="true";

image.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
        preview.src = reader.result;
        preview.classList.remove("hidden");
    };
    reader.readAsDataURL(file);
};

function resizeImage(base64,max=600){
    return new Promise(res=>{
        const img=new Image();
        img.onload=()=>{
            const scale=Math.min(max/img.width,max/img.height,1);
            const c=document.createElement("canvas");
            c.width=img.width*scale;
            c.height=img.height*scale;
            c.getContext("2d").drawImage(img,0,0,c.width,c.height);
            res(c.toDataURL("image/jpeg",0.8));
        };
        img.src=base64;
    });
}

// ADMIN FUNCTIONS
function openAdmin(){
    if(!isAdmin){loginModal.style.display="flex"; return;}
    store.classList.add("hidden");
    admin.classList.remove("hidden");
    renderOrders();
    renderEditProducts();
}

function login(){
    const user=document.getElementById("user").value;
    const pass=document.getElementById("pass").value;
    if(user==="admin" && pass==="admin123"){
        isAdmin=true;
        localStorage.setItem("admin","true");
        loginModal.style.display="none";
        openAdmin();
    } else alert("Wrong login");
}

function logout(){
    isAdmin=false;
    localStorage.removeItem("admin");
    admin.classList.add("hidden");
    store.classList.remove("hidden");
}

// ADD PRODUCT
async function addProduct(editId=null){
    const nameInput=document.getElementById("name");
    const priceInput=document.getElementById("price");
    const stockInput=document.getElementById("stock");
    const sizeInput=document.getElementById("size");

    if(editId===null && !image.files[0]) return alert("Select image");
    let base64=null;
    if(image.files[0]) base64=await resizeImage(preview.src);

    const sizeValues=sizeInput.value.split(",").map(s=>s.trim()).filter(s=>s);

    if(editId!==null){
        // Edit existing product
        const p=products.find(x=>x.id===editId);
        p.name=nameInput.value;
        p.price=+priceInput.value;
        p.stock=+stockInput.value;
        p.sizes=sizeValues;
        if(base64) p.image=base64;
    } else {
        products.push({
            id: Date.now(),
            name:nameInput.value,
            price:+priceInput.value,
            stock:+stockInput.value,
            sizes:sizeValues,
            image:base64
        });
    }

    localStorage.setItem("products",JSON.stringify(products));
    nameInput.value=priceInput.value=stockInput.value=sizeInput.value=image.value="";
    preview.classList.add("hidden");
    render();
    renderEditProducts();
}

// RENDER PRODUCTS
function render(){
    productGrid.innerHTML="";
    products.forEach(p=>{
        let sizeOptions=p.sizes.map(s=>`<option value="${s}">${s}</option>`).join("");
        productGrid.innerHTML+=`
        <div class="card">
            <img src="${p.image}">
            <div class="card-body">
                <h4>${p.name}</h4>
                <div class="price">$${p.price}</div>
                <div>Stock: ${p.stock}</div>
                <select id="sizeSelect-${p.id}">${sizeOptions}</select>
                <button class="btn btn-orange" onclick="addToCart(${p.id})" ${p.stock===0?"disabled":""}>Add to Cart</button>
                ${p.stock===0?'<div class="alert-stock">Out of Stock!</div>':''}
            </div>
        </div>`;
    });
    updateCartCount();
}

// CART FUNCTIONS
function addToCart(id){
    const p=products.find(x=>x.id===id);
    const selectedSize=document.getElementById(`sizeSelect-${id}`).value||"N/A";
    if(p.stock<=0) return alert("Out of stock!");

    const item=cart.find(i=>i.id===id && i.size===selectedSize);
    if(item) item.qty++; 
    else cart.push({id:p.id,name:p.name,price:p.price,size:selectedSize,qty:1});

    p.stock--;
    localStorage.setItem("products",JSON.stringify(products));
    localStorage.setItem("cart",JSON.stringify(cart));
    render();
}

function updateCartCount(){
    cartCount.textContent=cart.reduce((s,i)=>s+i.qty,0);
}

function openCart(){ renderCart(); cartModal.style.display="flex"; }
function closeCart(){ cartModal.style.display="none"; }

function renderCart(){
    let total=0, html="";
    cart.forEach(i=>{
        total+=i.price*i.qty;
        html+=`<div class="cart-item"><span>${i.name} (${i.size}) x ${i.qty}</span><span>$${(i.price*i.qty).toFixed(2)}</span></div>`;
    });
    cartItems.innerHTML=html||"<p>Empty</p>";
    cartTotal.textContent="Total: $"+total.toFixed(2);
}

// SEND ORDER
function sendOrder(){
    const cname=document.getElementById("cname").value;
    const cphone=document.getElementById("cphone").value;
    const caddr=document.getElementById("caddr").value;
    if(!cname || !cphone || !caddr) return alert("Fill customer info");

    let msg=`ðŸ›’ New Order%0AðŸ‘¤ ${cname}%0AðŸ“ž ${cphone}%0AðŸ“ ${caddr}%0A%0A`;
    let total=0;
    cart.forEach(i=>{
        msg+=`${i.name} (${i.size}) x ${i.qty} = $${(i.price*i.qty).toFixed(2)}%0A`;
        total+=i.price*i.qty;
    });
    msg+=`%0AðŸ’° Total: $${total}%0AðŸ’³ Pay online: ${PAYWAY_LINK}`;

    orders.push({date:new Date().toLocaleString(),name:cname,phone:cphone,total,items:[...cart]});
    localStorage.setItem("orders",JSON.stringify(orders));

    window.open(`https://m.me/${PAGE_NAME}?text=${msg}`,"_blank");
    cart=[];
    localStorage.removeItem("cart");
    closeCart();
    renderOrders();
    updateCartCount();
}

// ORDERS
function renderOrders(){
    const ordersDiv=document.getElementById("orders");
    ordersDiv.innerHTML="";
    orders.forEach(o=>{
        ordersDiv.innerHTML+=`
        <div class="order">
            <b>${o.date}</b><br>
            ${o.name} (${o.phone})<br>
            Total: $${o.total}
        </div>`;
    });
}

// ADMIN EDIT PRODUCTS
function renderEditProducts(){
    editProductsDiv.innerHTML="";
    products.forEach(p=>{
        editProductsDiv.innerHTML+=`
        <div class="order">
            ${p.name} - $${p.price} - Stock: ${p.stock}
            <button class="edit-btn" onclick="editProduct(${p.id})">Edit</button>
        </div>`;
    });
}

function editProduct(id){
    const p=products.find(x=>x.id===id);
    document.getElementById("name").value=p.name;
    document.getElementById("price").value=p.price;
    document.getElementById("stock").value=p.stock;
    document.getElementById("size").value=p.sizes.join(",");
    preview.src=p.image;
    preview.classList.remove("hidden");
    addProduct.editId=id;
    // override addProduct to edit
    addProduct = (async(editId=id)=> await addProduct(editId));
}

// INITIAL RENDER
render();
updateCartCount();
</script>

</body>
</html>
